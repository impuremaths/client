<!DOCTYPE html><html lang="en">
<head>
	<meta charset="UTF-8">
	<title>mktplc client</title>	
	<link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap"> 
	
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">	
</head>

<body>
	<div class="containerDiv">
	<div id="firstDiv" class="firstDiv">
		<div style="margin-left:18px; margin-right:18px; margin-bottom:5px; margin-top:5px; text-align:center">	
			<button id="account" class="left" onclick="toggleAccount()">Account</button>				
			<button class="right" onclick="">Post</button>
		</div>	

		<div id="accountPanel" class="accordion objectWrapper" style="max-height:0px; padding-top:0px; padding-bottom:0px; margin-top:0px">
			<div style="text-align:center;">
				<button tabindex="-1" class="left" onclick="generateSeed()">Generate Seed</button>
				<button id="current" tabindex="-1" style="font-size:0.85em; border-radius:5px" onclick="showCurrent()" autocomplete="off" disabled>Current Seed</button>
				<button class="right" onclick="if (confirm('Clear all data, including the current seed?')) clickClearSeed();">Clear Account</button>
			</div>
			<div style="display:flex; justify-content:space-between; margin-top:15px;">
				<input id="seed" placeholder="Private seed (store securely) ..." style="padding-right:30px; flex-grow:1; flex-basis:20px; margin-right:10px;" type="password" autocomplete="off" onclick="this.select()" oninput="importSeed();">
				<button  tabindex="-1" class="close-icon" onclick="closeCopy(this.previousElementSibling)"></button>			
				<button id="show" tabindex="-1" style="font-size:0.85em; margin-right:5px;" onclick="toggleVisibility()">Show</button>
			</div>
		</div>
		
		<div class="objectWrapper">
			<div class="clickFlash" style="display:flex; justify-content:space-between" onclick="toggleEdit();">
				<strong style="overflow:hidden"><div id="displayName" style="text-overflow:ellipsis; overflow:hidden; font-size:1.2em;" class="flash">✏️ My Account</div></strong>
			</div>

			<div id="editpanel" class="accordion" style="max-height:0px">			
				<div style="display:flex; justify-content:space-between;">
					<input placeHolder="Display name (public) ..." id="set-name" 
					       style="padding-right:30px; flex-grow:1; margin-right:10px;" type="text"autocapitalize="off" maxlength="64"
					       onkeyup="if (event.keyCode == 13) setData('name'); if (event.keyCode == 27) this.value = '';">
					<button  tabindex="-1" class="close-icon" onclick="closeCopy(this.previousElementSibling)"></button>
					<button style="font-size:0.85em" onclick="setData('name')">Set</button>
				</div>
				<div class='address' style="margin-top:10px" id="address" onclick="clickCopy(this, this.textContent)">&nbsp;</div>
			</div>	
		</div>			
	</div>
	<div id="secondDiv" class="secondDiv">
		<div style="margin-top:30px">
			<button onclick="ping()">Server time</button> 
			<span id="serverTime">Unknown</span>
		</div>
		
		<!-- TESTING CODE -->
		<div style="margin-top:30px">
			<span id="test-identity">Currently not authenticated.</span>
		</div>

		<div style="margin-top:30px">
			<input type="text" id="test-fetch-input"></input><br />
			<button onclick="testFetch()">Fetch!</button><br />
			<span id="test-fetch">Unknown</span>
		</div>

		<div style="margin-top:30px">
			<input type="text" id="test-post-createdts-input" placeholder="createdts, required if update"></input><br />
			<input type="text" id="test-post-title-input" placeholder="title"></input><br />
			<input type="text" id="test-post-content-input" placeholder="content"></input><br />
			<select name="visibility" id="test-post-visibility-input">
				<option value="private">Private</option>
				<option value="subscriber">Subscriber</option>
				<option value="public">Public</option>
			</select><br />
			<button onclick="testPost()">Post!</button><br />
			<button onclick="testDelete()">Delete!</button><br />
			<span id="test-post">Unknown</span>
		</div>
		<!-- END TESTING CODE -->
	</div>
	</div>
	

<script src="nacl.js"></script>
<script src="xno.js"></script>
<script src="tweetnacl.js"></script>
<script>



// Global variables and macros ///////////////////////////////////////////////////////////////////////

const enc = new TextEncoder();
const dec = new TextDecoder();
function D(string) { return document.getElementById(string); }

var XNO = {};

// crypto methods ///////////////////////////////////////////////////////////////////////

XNO.checkSeed = function(seed) { return typeof seed === "string" && /^[0-9a-fA-F]{64}$/.test(seed);};

XNO.checkAddress = function(address) { 
	if (!(typeof address === "string") || !/^(xrb_|nano_)[13][13-9a-km-uw-z]{59}$/.test(address)) return false;
	let prefixLength = 5;
	if (address.startsWith('xrb_')) prefixLength = 4;

	const publicKeyBytes = decodeNanoBase32(address.substr(prefixLength, 52));
	const checksumBytes = decodeNanoBase32(address.substr(prefixLength + 52));
	const computedChecksumBytes = blake2b(publicKeyBytes, null, 5).reverse();
	for (let i = 0; i < checksumBytes.length; i++) {
		if (checksumBytes[i] !== computedChecksumBytes[i]) return false;
	}
	return true;
};

XNO.generateSeed = function() {
	const seed = new Uint8Array(32);
	crypto.getRandomValues(seed);
	return Array.prototype.map.call(seed, (x) => ('00' + x.toString(16)).slice(-2)).join('').toUpperCase();
};

XNO.addressFromSeed = function(seed) {
	let privateKey = XNO.derivePrivateKey(seed, 0);
	let publicKey = XNO.pubFromPriv(privateKey);
	return XNO.addrFromPub(publicKey);	
}

XNO.derivePrivateKey = function(seed, index) {
  const indexBuffer = new ArrayBuffer(4)
  const indexView = new DataView(indexBuffer)
  indexView.setUint32(0, index)
  const indexBytes = new Uint8Array(indexBuffer)

  const context = blake2bInit(32)
  blake2bUpdate(context, hexToByteArray(seed))
  blake2bUpdate(context, indexBytes)
  return byteArrayToHex(blake2bFinal(context))
}

XNO.pubFromPriv = function(privateKey) { return byteArrayToHex(derivePublicFromSecret(hexToByteArray(privateKey))); };
XNO.addrFromPub = function(publicKey) { return 'nano_' + encodeNanoBase32(hexToByteArray(publicKey)) + encodeNanoBase32(blake2b(hexToByteArray(publicKey), null, 5).reverse()); }
XNO.pubFromAddr = function(address) { return byteArrayToHex(decodeNanoBase32(address.substr(5, 52))); };

XNO.sign = function(message) { return byteArrayToHex(signDetached(enc.encode(message), hexToByteArray(XNO.privateKey))); }
XNO.verify = function(message, signature, address) {
	try { return verifyDetached(enc.encode(message), hexToByteArray(signature), hexToByteArray(XNO.pubFromAddr(address))); }
	catch { return false };
}

XNO.unpackSeed = function(seed, index) {
	XNO.seed = seed;
	XNO.privateKey = XNO.derivePrivateKey(seed, index);
	XNO.publicKey = XNO.pubFromPriv(XNO.privateKey);
	XNO.address = XNO.addrFromPub(XNO.publicKey);
	XNO.encryptKey = nacl.box.keyPair.fromSecretKey(hexToByteArray(XNO.privateKey));
}

function byteArrayToHex(byteArray) {
  if (!byteArray) return '';
  let hexStr = '';
  for (let i = 0; i < byteArray.length; i++) {
    let hex = (byteArray[i] & 0xff).toString(16)
    hex = hex.length === 1 ? `0${hex}` : hex;
    hexStr += hex;
  }
  return hexStr.toUpperCase()
}

function hexToByteArray(hex) {
  if (!hex) return new Uint8Array();
  const a = [];
  for (let i = 0; i < hex.length; i += 2) {
    a.push(parseInt(hex.substr(i, 2), 16));
  }
  return new Uint8Array(a);
}

// Websocket code ///////////////////////////////////////////////////////////////////////

var serverURL = 'wss://impuremaths.herokuapp.com';
var ws = new WebSocket(serverURL);
setupWebsocket();

function setupWebsocket(restart) {
	ws.onopen = function() { console.log("Connected to server!"); };
	ws.onclose = function() { 
		ws = new WebSocket(serverURL);
		setupWebsocket(true);
	}

	ws.customEvents = {};
	ws.on = function(cueName, eventAction) { ws.customEvents[cueName] = eventAction; };
	ws.emit = function(cueName, payload) { 
		if (ws.readyState == 1) ws.send(JSON.stringify({cueName:cueName, payload:payload})); 
		return (ws.readyState == 1);
	};
	ws.onmessage = function(event) {
		let data;
		try { data = JSON.parse(event.data); }
		catch { 
			console.log("Unparseable server message.")
			console.error(event.data);
			return false;
		}			
		if (data && data.cueName && ws.customEvents[data.cueName]) ws.customEvents[data.cueName](data.payload);
		else {
			console.log("Unrecognized server message.")
			console.error(event.data);
		}
	};

	// Custom commands	
	ws.on('serverPongCue', function(data) { 
		document.getElementById("serverTime").textContent = data;
	});

	ws.on('authenticateUserResponse', function(data) {
		document.getElementById('test-identity').textContent = `Currently authenticated as: ${data}`;
	});

	ws.on('readContentFromUserResponse', function(data) {
		document.getElementById('test-fetch').textContent = data;
	});

	ws.on('writePostResponse', function(data) {
		dataObj = JSON.parse(data);
		document.getElementById('test-post-createdts-input').value = dataObj.createdts;
		document.getElementById('test-post').textContent = data;
	});

	ws.on('deletePostResponse', function(data) {
		document.getElementById('test-post').textContent = data;
	});
}

function ping() {
	if (ws) ws.emit('clientPingCue');
}

function testFetch() {
	if (!ws) return;
	ws.emit(
		'readContentFromUser',
		{ userid: document.getElementById('test-fetch-input').value },
	);
}

function testPost() {
	if (!ws) return;
	var post = { 
		title: document.getElementById('test-post-title-input').value,
		content: document.getElementById('test-post-content-input').value,
		visibility: document.getElementById('test-post-visibility-input').value,
	};
	if (document.getElementById('test-post-createdts-input').value) {
		post['createdts'] = Number(document.getElementById('test-post-createdts-input').value);
	}
	ws.emit(
		'writePost',
		post,
	);
}

function testDelete() {
	if (!ws) return;
	ws.emit(
		'deletePost',
		{ createdts: Number(document.getElementById('test-post-createdts-input').value) },
	);
}

// UI interaction handlers ///////////////////////////////////////////////////////////////////////

var clipboardText;

function generateSeed() {
	if (XNO.address && !confirm('Overwrite the current seed?')) return false;
	let newSeed = XNO.generateSeed();
	inputEvent(D("seed"), newSeed);
	navigator.clipboard.writeText(newSeed);
	clipboardText = newSeed;
	console.log("New seed copied to clipboard. Store it safely, elsewhere! (Find it again via 'Account' button.)");
}

function importSeed() {
	let seed = D("seed").value;
	let index = 0;	
	if (!XNO.checkSeed(seed)) { if (XNO.checkAddress(seed)) showMsg("Enter a seed, not an address."); }
	else if (index.length > 0 && (!/^[0-9]+$/.test(index) || index < 0 || index > Math.pow(2, 32) - 1)) showMsg("Invalid account index.");
	else {
		let keepAccount = XNO.address;
		clearSeed();		
		XNO.unpackSeed(seed, parseInt(index));		
		D("current").disabled = false;
		
		if (!keepAccount && D("accountPanel").style.maxHeight != "0px") toggleAccount();
		D('address').textContent = XNO.address;

		if (ws) ws.emit('authenticateUser', makePostHeader() );
	}
}

function showCurrent() {
	if (XNO.seed) {
		D(`seed`).value = XNO.seed;
		flash(D(`seed`));
	} else console.log("No seed loaded.");
}

function clearSeed() {
	XNO.privateKey = "";
	XNO.publicKey = "";
	XNO.address = "";
	XNO.index = "";
	XNO.seed = "";
	XNO.encryptKey = "";
}

function clickClearSeed() {
	clearSeed();
	
	inputEvent(D('seed'), "");
	D("current").disabled = true;
	D('address').textContent = "";
	D('displayName').textContent = "";
}

function makePostHeader() {
	let header = {userid: XNO.address, ts:Date.now()};
	header.signature = XNO.sign(header.ts, XNO.address);
	console.log(header);
	return header;
}

function toggleAccount() {
	if (D('seed').type != "password") toggleVisibility();
	
	let obj = D("accountPanel");
	if (obj.style.maxHeight == "0px") {
		if (XNO.seed) D('seed').value = XNO.seed; 
		
     	showAccordion(obj);
		obj.style.padding = "";
		obj.style.marginTop = "5px";
		D('account').classList.add('active');
		setTimeout(function() { if (obj.style.maxHeight != "0px") obj.style.maxHeight = ""; }, 100);
	} else {	
		D("seed").value = "";		
     	showAccordion(obj);
		setTimeout(function() {
			hideAccordion(obj);
			hideAccordionPadding(obj);
			D('account').classList.remove('active');
		}, 1);
	}
}

function toggleVisibility() {
	let x = D("seed");
	if (x.type === "password") {
		x.type = "text";
		D("show").classList.add('active');
	} else {
		x.type = "password";		
		D("show").classList.remove('active');
	}
}

function toggleEdit() {
	let obj = D("editpanel");
	if (obj.style.maxHeight == "0px") {
		showAccordion(obj);
		obj.style.marginTop = "10px";
		obj.style.marginBottom = "20px";
	} else {	
		hideAccordion(obj);
     		obj.style.marginBottom = "0px";
	}
}
	
function setData(type) {
	console.error("Need code to set " + type);
}


// Global event listeners ///////////////////////////////////////////////////////////////////////

window.addEventListener('copy', function(e) { 
	if (document.activeElement.tagName.toLowerCase() == 'input') clipboardText = document.activeElement.value.substring(document.activeElement.selectionStart, document.activeElement.selectionEnd);
	else {
		if (document.getSelection().toString()) {
			clipboardText = document.getSelection().toString();	
			navigator.clipboard.writeText(clipboardText);
		}
	}
});

// UI helper library ///////////////////////////////////////////////////////////////////////

function D(string) { return document.getElementById(string); }

function showAccordion(obj) { obj.style.maxHeight = obj.scrollHeight + "px"; }

function hideAccordion(obj) {
	obj.style.maxHeight = "0px";
	obj.style.marginTop = "0px";
}

function hideAccordionPadding(obj) {
	obj.style.paddingTop = "0px";
	obj.style.paddingBottom = "0px";
}

function flash(elt, str) {
	if (elt) {
		if (str != undefined) elt.textContent = str;
		elt.style.backgroundColor = 'aliceblue';	
		setTimeout(function() {	elt.style.backgroundColor = "";}, 500);
	} else console.log("Element disappeared before display.");
}

function inputEvent(obj, value) {
	obj.value = value;
	obj.dispatchEvent(new Event('input', {bubbles:true}));
	if (value) flash(obj);
}

function closeCopy(obj) {
	if (obj.value.length > 0) inputEvent(obj, "");
	else if (navigator.clipboard.readText) {
		navigator.clipboard.readText()
			.then(function(text) { inputEvent(obj, text); })
			.catch(function() { if (clipboardText) inputEvent(obj, clipboardText); });
	}
	else if (clipboardText) inputEvent(obj, clipboardText);
}

function clickCopy(elt, str) {
	if (str.length > 1) {
		/* Copy the text inside the text field */
		navigator.clipboard.writeText(str);
		clipboardText = str;
		showMsg("Copied to clipboard.");
	}
	flash(elt);
}

</script>

</body>
</html>
