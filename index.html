<!DOCTYPE html><html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Brewri</title>	
	<link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap"> 
	
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">	
</head>

<body>
	<strong id="msg" class="msg" style="display:none;"></strong>
	
	<div class="outermostContainer">
	
	<div id="leftSidebar" class="leftSidebar" style="background-color:hsl(0, 0%, 80%)">	
	
		<div id="profilePanel" class="objectWrapper" style="margin-top:30px; margin-bottom:5px" onclick="openSubAccordion(this)">
			<div class="clickFlash" style="display:flex; justify-content:space-between; margin:0px 10px; align-items:baseline" onclick="toggleSubAccordion(this)">
				<div id="displayName" style="text-overflow:ellipsis; overflow:hidden; font-size:1.1em; white-space:nowrap; font-weight:bold; flex-grow:1" class="flash">Guest</div>
				<a id="abtLink" class="clickFlash" style="font-size:0.9em; margin-left:5px;" href="">( ? )</a>
			</div>

			<div id="editPanel" class="accordion" style="max-height:0px; margin:0px 10px">
				<div style="text-align:center; margin-top:20px">
					<button tabindex="-1" class="left" onclick="generateSeed()">Generate PIN</button><button id="currentLoginButton" class="center" tabindex="-1" onclick="showCurrent()" autocomplete="off" disabled>Current PIN</button><button id="logoutButton" class="right" onclick="if (confirm('Log out of the current account? (Have you saved your account PIN elsewhere?!)')) clickClearSeed();" autocomplete="off" disabled>Log Out</button>
				</div>
				
				<div style="display:flex; justify-content:space-between; margin-top:15px; margin-bottom:5px">
					<input id="seed" placeholder="PIN (secret - save securely)..." style="padding-right:30px; flex-grow:1; flex-basis:20px;" type="password" autocomplete="off" onclick="this.select()" oninput="importSeed();">
					<button  tabindex="-1" class="close-icon" onclick="closeCopy(this.previousElementSibling)"></button>			
					<button id="show" tabindex="-1" style="font-size:0.85em; margin-left:10px" onclick="toggleVisibility()">Show</button>
				</div>
			</div>	
		</div>	
		
		<div id="notePanel" class="objectWrapper" style="padding-right:0px; overflow:hidden; display:none; flex-direction:column; flex-shrink:0; max-height:33vh" onclick="openSubAccordion(this); refreshNoteCounter()">
			<div class="clickFlash leftRightBase" style="margin:0px 10px" onclick="toggleSubAccordion(this)">
				<div id="notificationHeading" style="font-size:0.9em; color:#888; margin-left:0px; flex-grow:1">Activity</div>
				<div id="balance" class="clickFlash" style="overflow:hidden; text-overflow:ellipsis; flex-shrink:0; max-width:60%; font-size:0.9em; margin-left:5px; color:#888">0.00</div><span style="font-size:0.9em; color:#888" onclick="refreshBalance(); event.stopPropagation()">&nbsp;XNO</span>
			</div>
			<div class="accordion" style="max-height:0px">
				<div id="notificationPlaceholder" style="font-style:italic; color:#888; text-align:center; margin-top:20px">- no activity -</div>
				<ul id="notifications" style="overflow:auto; max-height:calc(100% - 15px); margin-left:10px; margin-top:10px; margin-bottom:5px;"></ul>
			</div>
		</div>
		
		<div id="subPanel" class="objectWrapper" style="padding-right:0px; overflow:hidden; display:none; flex-direction:column; flex-shrink:0; max-height:33vh" onclick="openSubAccordion(this)">
			<div class="clickFlash leftRightBase" style="margin:0px 10px" onclick="toggleSubAccordion(this)">
				<span style="font-size:0.9em; color:#888; margin-left:0px">Subscriptions</span>
			</div>
			<div class="accordion">
				<ul id="subscriptions" style="overflow:auto; max-height:calc(100% - 15px); margin-left:10px; margin-top:10px; margin-bottom:5px;"></ul>
			</div>
		</div>

		<div class="objectWrapper" style="padding-right:0px; margin-bottom:10px; overflow:hidden; display:flex; flex-direction:column" onclick="openSubAccordion(this)">
			<div class="clickFlash leftRightBase" style="margin:0px 10px" onclick="toggleSubAccordion(this)">
				<span style="font-size:0.9em; color:#888; margin-left:0px">My Library</span>
			</div>
			<div class="accordion">
				<div id="libraryPlaceholder" style="font-style:italic; color:#888; text-align:center; margin-top:20px">- no history (sign in to persist) -</div>
				<ul id="library" style="overflow:auto; max-height:calc(100% - 15px); margin-left:10px; margin-top:10px; margin-bottom:5px"></ul>
			</div>
		</div>
		
	</div>
	
	<div id="centralWindow" class="centralWindow">
	<div id="centralWindowScroller" class="centralWindowScroller">
	
		<div class="controlbar">
			<div class="controlpanel">
				<button id="browseButton" style="min-width:fit-content" class="left active" onclick="loadPanel('browse', true)" title="Alt + 1">Browse</button><button id="readButton" style="min-width:fit-content" class="center" onclick="loadPanel('read', true)" autocomplete="off" title="Alt + 2">Read</button><button id="writeButton" style="min-width:fit-content" class="right" onclick="loadPanel('write', true)" autocomplete="off" title="Alt + 3">Write</button>
			</div>
		
			<div id="popularTags" class="popularTags scroll-shadows hideScroll desktop">
				<a onclick="queryBrowse();" style="flex-shrink:0; cursor:pointer; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:250px; font-weight:600; color:#333">Recent</a>
			</div>
		</div>
		
		<div id="browse" style="padding-bottom:80px; max-width:1200px">			
			<div style="margin-bottom:5px">
				<span style="font-weight:bold; font-size:1.1em; cursor:pointer;" onclick="queryBrowse(browseURL)" id="browseHeading"></span>
				<span id="loadingMsg" style="margin-left:10px; font-style:italic; display:none">Loading...</span>
			</div>
			<div style="display:flex">			
				<button id="toggleBrowse" class="mobile" onclick="toggleSecondDiv(this)">. . .</button>
				<div style="flex-basis:1px; flex-grow:5;">
					<div id="browsePlaceholder" style="font-style:italic; color:#888; text-align:center; margin-top:20px; display:none">- no posts -</div>
					<ul id="browseList"></ul>
				</div>
				
				<div class="sidebar desktop" style="flex-grow:4; margin-left:40px;">					
					<div id="bioPreview" style="overflow:hidden; display:none">
						<div id="bio" style="font-size:0.9em; margin-top:30px; margin-bottom:2em"></div>
						
						<div style="display:flex; justify-content:right;">
							<button id="profileBut" onclick="openBioEditor()" style="font-size:0.85em">Update Profile</button>
							<div id="bioLine" class="horizontalLine"></div>						
							<button id="subscribe" onclick="subscribeHandler()" autocomplete="off" style="font-size:0.85em" disabled>Subscribe</button>
							&nbsp;<button id="sponsor" onclick="sponsorHandler()" autocomplete="off" style="font-size:0.85em" disabled>Sponsor</button>	
						</div>
				
						<div id="bioSponsor" style="margin:1.5em auto; max-width:fit-content; display:none;">
							<div id="theirFunName" style="margin-bottom:10px; font-weight:600"> - </div>					
							<div style="font-size:0.85em; color:#888">Unique public address</div>
							<div class='address' id="theirAddress" style="margin:5px 10px 15px 10px;" onclick="clickCopy(this, this.textContent)"> - </div>
							<div style="font-size:0.85em; color:#888">Premium sponsorship • 30 days</div>
							<span id="theirThreshold" style="margin:5px 0px 15px 10px; cursor:pointer; border-radius:3px" onclick="clickPaste(this, false)">&nbsp;-&nbsp;</span>&nbsp;XNO
							<div style="display:flex; justify-content:space-between; align-items:baseline; max-width:400px; margin:10px auto">
							<input id="sponsorInput" onfocus="scrollPanel(this)" onkeyup="" onkeydown="" placeholder="0.00" onblur="prepTwoDigit(this)" style="scroll-margin:10px; margin-right:5px; text-align:right; flex-grow:1; flex-basis:1px; overflow:hidden; text-overflow:ellipsis;" type="number" step="0.01" min="0" autocomplete="off"> XNO							
							<button id="sendButton" onclick="sendMoney()" autocomplete="off" style="margin-left:20px; font-size:0.85em" disabled>Send</button>
							</div>
						</div>
					</div>
					
					<div id="bioEditor" style="display:none">					
						<input id="bio-name" style="width:100%; margin-bottom:10px; margin-top:30px; font-size:1em; font-weight:600" autocomplete="off" placeholder="Public display name..." type="text" onkeyup="if (event.keyCode == 27) this.value = '';" maxlength="64">

						<input class="colorslider" id="colorslider" type="range" min="0" max="360" step="1" oninput="color(this)" value="0" autocomplete="off"/>														
														
						<div id="bioBlocks" style="margin-top:2em; margin-bottom:2em"></div>
						<div style="font-size:0.85em; margin-top:20px; color:#888">Premium sponsorship • 30 days</div>
						<div style="display:flex; justify-content:right; margin-top:5px; align-items:baseline">
						<input onfocus="scrollPanel(this)" id="inputPrice" onkeyup="" onkeydown="" autocomplete="off" placeholder="0.00" onblur="prepTwoDigit(this)" style="margin-left:20px; margin-right:5px; text-align:right; flex-grow:1; flex-basis:1px; overflow:hidden; text-overflow:ellipsis;" type="number" step="0.01" min="0"><span style="font-size:0.9em">XNO</span>
						</div>
						
						<button onclick="setData()" style="margin-top:30px">Update</button>
						<button onclick="closeBioEditor()">Cancel</button>
					</div>
				</div>
			</div>
		</div>

		<div id="write" style="display:none; padding-bottom:80px; max-width:1200px;">		
			<button id="toggleEdit" class="mobile" onclick="toggleSecondDiv(this)">. . .</button>
		
			<div style="flex-basis:1px; flex-grow:2; position:relative; margin-top:0.5em;">
			
				<div style="display:flex; justify-content:center; position:absolute; right:0px; top:-20px;">
					<button id="editButton" class="left active" onclick="showEditor()" title="Alt + Q">Editor</button><button id="previewButton" class="right" style="margin-left:4px" onclick="showPreview()" title="Alt + W">Preview</button>
				</div>
				
				<div id="postEditor" style="margin-top:1.5em"></div>
				<div id="postPreview" style="margin-top:1.5em; display:none"></div>
				
			</div>
			
			<div class="sidebar desktop" style="max-width:360px;">
				<input id="postTitle" style="font-weight:bold; font-size:1.1em; width:100%; margin-bottom:10px;" autocomplete="off" placeholder="Title (required)..." type="text" onkeyup="if (event.keyCode == 27) this.value = '';">
				<div id="editid" style="font-size:0.85em; margin-left:10px; display:none">
					<span id="creationEdit"></span><span id="modificationEdit" style="font-style:italic;"></span>
				</div>
				
				<div id="editTags" style="font-size:0.85em; margin-top:15px"></div>
				<div style="display:flex; margin-top:10px">
					<input id="set-tag" style="padding-right:30px; flex-grow:1; margin-right:10px" autocomplete="off" placeHolder="tag (lowercase)..." type="text" onkeyup="if (event.keyCode == 27) this.value = ''; if (event.keyCode == 13) { addTag(); D('set-tag').select(); }" onblur="addTag()" autocapitalize="off" maxlength="64">
					<button tabindex="-1" style="font-size:0.85em; min-width:fit-content" onclick="addTag(); D('set-tag').select();">Add</button>
				</div>
						
				<div style="display:flex; margin-top:30px; justify-content:space-between; align-items:baseline">
					<span style="text-overflow:ellipsis; overflow:hidden; white-space:nowrap; font-size:0.9em; font-weight:bold">(none)</span>
				</div>
				
				<div style="margin-top:5px; display:flex; justify-content:space-between; flex-grow:1">
					<input placeHolder="URL to preceding post..." id="set-prev" autocomplete="off"
						   style="padding-right:30px; flex-grow:1; width:1px" type="text" autocapitalize="off" onkeyup="if (event.keyCode == 27) this.value = ''; checkTitle(this);" oninput="checkTitle(this);">
					<button tabindex="-1" class="close-icon" onclick="closeCopy(this.previousElementSibling)"></button>
					<button id="recip-prev" onclick="toggle(this)" tabindex="-1" style="font-size:0.85em; min-width:fit-content; margin-left:10px" disabled>Reciprocate</button>
				</div>
				
				<div style="display:flex; margin-top:30px; justify-content:space-between; align-items:baseline">
					<span style="text-overflow:ellipsis; overflow:hidden; white-space:nowrap; font-size:0.9em; font-weight:bold">(none)</span>
				</div>
				
				<div style="margin-top:5px; display:flex; justify-content:space-between; flex-grow:1">
					<input onfocus="scrollPanel(this)" placeHolder="URL to next post..." id="set-next" autocomplete="off"
						   style="padding-right:30px; flex-grow:1; width:1px" type="text" autocapitalize="off" onkeyup="if (event.keyCode == 27) this.value = ''; checkTitle(this);"oninput="checkTitle(this);">
					<button tabindex="-1" class="close-icon" onclick="closeCopy(this.previousElementSibling)"></button>
					<button id="recip-next" onclick="toggle(this)" tabindex="-1" style="font-size:0.85em; min-width:fit-content; margin-left:10px" disabled>Reciprocate</button>
				</div>
					
				
				<div style="margin-top:50px; display:flex;">
					<button id="publishButton" onclick="publish()" tabindex="-1" disabled>Publish</button>
					<button id="clearButton" style="margin-left:5px" tabindex="-1" onclick="cancelPost()">Clear</button>	
				</div>
			</div>
		</div>
		
		<div id="read" style="display:none; padding-bottom:80px; max-width:1200px;">
			<button id="toggleRead" class="mobile" onclick="toggleSecondDiv(this)">. . .</button>
			<div style="flex-basis:1px; flex-grow:2; overflow:hidden">				
				<div id="readContent" style="margin-bottom:2.5em; margin-top:2em">Browse for something interesting!</div>
				
				
				<textarea id="commentContent" onfocus="scrollPanel(this)" style="margin-top:10px; margin-bottom:15px; height:80px; width:100%; display:none; font-family:Segoe UI, Source Sans Pro, Roboto, Helvetica, sans-serif; font-size:0.9em" autocomplete="off" onkeyup="commentKeypress()" oninput="commentKeypress()" placeholder="Comment..."></textarea>
				<div style="display:flex; justify-content:right;">				
					<button id="edit2" onclick=" fillEdit();" style="font-size:0.85em; display:none">Update</button>
					<div class="horizontalLine"></div>										
					<button id="subscribe2" onclick="subscribeHandler(D('author').title)" autocomplete="off" style="font-size:0.85em" disabled>Subscribe</button>				
					&nbsp;<button id="sponsor2" onclick="postSponsorHandler()" autocomplete="off" style="font-size:0.85em" disabled>Sponsor</button>
					&nbsp;<button id="comment" onclick="comment()" autocomplete="off" style="font-size:0.85em" disabled>Comment</button>
				</div>
				
				<div id="postSponsor" style="margin:1.5em auto 3em auto; max-width:fit-content; display:none">
					<div id="postTheirFunName" style="margin-bottom:10px; font-weight:600"> - </div>					
					<div style="font-size:0.85em; color:#888">Unique public address</div>
					<div class='address' id="postTheirAddress" style="margin:5px 10px 15px 10px;" onclick="clickCopy(this, this.textContent)"> - </div>
					<div style="font-size:0.85em; color:#888">Premium sponsorship • 30 days</div>
					<span id="postTheirThreshold" style="margin:5px 0px 15px 10px; cursor:pointer; border-radius:3px" onclick="clickPaste(this, true)">&nbsp;-&nbsp;</span>&nbsp;XNO
					<div style="display:flex; justify-content:space-between; align-items:baseline; max-width:400px; margin:10px auto">
					<input id="postSponsorInput" onfocus="scrollPanel(this)" onkeyup="" onkeydown="" placeholder="0.00" onblur="prepTwoDigit(this)" style="scroll-margin:80px; margin-right:5px; text-align:right; flex-grow:1; flex-basis:1px; overflow:hidden; text-overflow:ellipsis;" type="number" step="0.01" min="0" autocomplete="off"> XNO							
					<button id="postSendButton" onclick="sendMoney(true)" autocomplete="off" style="margin-left:20px; font-size:0.85em" disabled>Send</button>
					</div>
				</div>
				
				<ul id="readComments" style="margin-top:1.5em"><ul>
			</div>
			
			<div class="sidebar desktop" style="max-width:360px;">			
				<div id="readTitle" style="font-weight:bold; font-size:1.1em; margin-bottom:3px; cursor:pointer">Title</div>	
				
				<div style="font-size:0.85em">
					<div id="tags">
						<a id="author" onclick="queryBrowse({userid:this.title})" style="cursor:pointer; font-weight:600">Author</a>
						<a onclick="queryBrowse({tag:this.title})" style="cursor:pointer"> • tags</a>
					</div>
				
					<div style="margin-top:3px">
						<span id="creation">Date published</span><span id="modification" style="font-style:italic;">  •&nbsp;date updated</span>
						<a id="edit" onclick="event.preventDefault(); fillEdit();" style="cursor:pointer; display:none"> • Update</a>
					</div>
				</div>
				
				<ul id="mapul"></ul>
			</div>
		</div>
		
	</div>
	</div>
	
	</div>
	
<script src="nacl.js"></script>
<script src="xno.js"></script>
<script src="tweetnacl.js"></script>
<script src="dompurify.js"></script>
  <script src="marked.js"></script>
<script>

// Raw crypto methods ///////////////////////////////////////////////////////////////////////

var XNO = {};
var hardMax = 100;

XNO.checkSeed = function(seed) { return typeof seed === "string" && /^[0-9a-fA-F]{64}$/.test(seed);};

XNO.checkAddress = function(address) { 
	if (!(typeof address === "string") || !/^(nano_)[13][13-9a-km-uw-z]{59}$/.test(address)) return false;
	const checksumBytes = decodeNanoBase32(address.substr(5 + 52));
	const computedChecksumBytes = blake2b(decodeNanoBase32(address.substr(5, 52)), null, 5).reverse();
	for (let i = 0; i < checksumBytes.length; i++) {
		if (checksumBytes[i] !== computedChecksumBytes[i]) return false;
	}
	return true;
};

XNO.generateSeed = function() {
	const seed = new Uint8Array(32);
	crypto.getRandomValues(seed);
	return Array.prototype.map.call(seed, (x) => ('00' + x.toString(16)).slice(-2)).join('').toUpperCase();
};

XNO.derivePrivateKey = function(seed, index) {
  const indexBuffer = new ArrayBuffer(4)
  const indexView = new DataView(indexBuffer)
  indexView.setUint32(0, index)
  const indexBytes = new Uint8Array(indexBuffer)

  const context = blake2bInit(32)
  blake2bUpdate(context, hexToByteArray(seed))
  blake2bUpdate(context, indexBytes)
  return byteArrayToHex(blake2bFinal(context))
}

XNO.pubFromPriv = function(privateKey) { return byteArrayToHex(derivePublicFromSecret(hexToByteArray(privateKey))); };
XNO.addrFromPub = function(publicKey) { return 'nano_' + encodeNanoBase32(hexToByteArray(publicKey)) + encodeNanoBase32(blake2b(hexToByteArray(publicKey), null, 5).reverse()); }
XNO.pubFromAddr = function(address) { return byteArrayToHex(decodeNanoBase32(address.substr(5, 52))); };

XNO.sign = function(message) { return byteArrayToHex(signDetached(enc.encode(message), hexToByteArray(XNO.privateKey))); }

XNO.unpackSeed = function(seed, index) {
	XNO.seed = seed;
	XNO.privateKey = XNO.derivePrivateKey(seed, index);
	XNO.publicKey = XNO.pubFromPriv(XNO.privateKey);
	XNO.address = XNO.addrFromPub(XNO.publicKey);
	XNO.encryptKey = nacl.box.keyPair.fromSecretKey(hexToByteArray(XNO.privateKey));
}

function byteArrayToHex(byteArray) {
  if (!byteArray) return '';
  let hexStr = '';
  for (let i = 0; i < byteArray.length; i++) {
    let hex = (byteArray[i] & 0xff).toString(16)
    hex = hex.length === 1 ? `0${hex}` : hex;
    hexStr += hex;
  }
  return hexStr.toUpperCase()
}

function hexToByteArray(hex) {
  if (!hex) return new Uint8Array();
  const a = [];
  for (let i = 0; i < hex.length; i += 2) {
    a.push(parseInt(hex.substr(i, 2), 16));
  }
  return new Uint8Array(a);
}

function prepTwoDigit(elt) { if (elt.validationMessage != 'Please enter a number.') elt.value = twoDigit(elt.value); }

function twoDigit(str) {
	if (!str) return str;
	let parts = str.toString().split(".");
	if (parts[0].length == 0) parts[0] = "0";
	let fraction = '';
	if (parts.length > 1) fraction = parts[1];
	while (fraction.length < 2) {
		fraction += '0';
	}
	while (fraction[fraction.length - 1] == "0" && fraction.length > 2) {
		fraction = fraction.slice(0, -1);
	}
	return `${parts[0]}.${fraction}`;	
}

// Higher level crypto methods ///////////////////////////////////////////////////////////////////////

let ccc = {};
ccc['XNO'] = {shift:30, server:'https://rainstorm.city/api', // 'https://proxy.nanos.cc/proxy',	
						powArray: ['https://rainstorm.city/api', 'https://proxy.nanos.cc/proxy'],
						representative:'nano_1natrium1o3z5519ifou7xii8crpxpk8y65qmkih8e8bpsjri651oza8imdd',
						repRec:'https://mynano.ninja/api/accounts/verified'};
						
for (let symbol in ccc) { ccc[symbol].queue = new Promise(function(resolve, reject) { resolve(true); }); }
	
ccc['XNO'].getPending = function() {return post(ccc['XNO'].server, {action: 'pending', account: XNO.address, source:true}); };
ccc['XNO'].getBlock = function(hash) { return post(ccc['XNO'].server, {action: 'block_info', json_block: true, hash: hash}); };	

ccc['XNO'].receive = function(hash) { return enqueue('XNO', async function() {
	let symbol = 'XNO';
	let blockInfoFetch = ccc['XNO'].getBlock(hash);
	let oldBalance = '0';
	let previous = '0'.padStart(64, '0');
	let representative = ccc[symbol].representative;
	let workInput = XNO.publicKey;
	
	let frontierBlock = await fetchFrontier(symbol);
	if (frontierBlock) {
		oldBalance = frontierBlock.balance;
		previous = frontierBlock.hash;
		representative = frontierBlock.representative;
		workInput = frontierBlock.hash;
	} else {
		console.log("Fetched frontier failed check; attempting open block.");
		await fetch(ccc[symbol].repRec).then(function(response) {
			return response.json().then(function(data) { 
				if (!data) return false;
				data.sort(function(x, y) { return y.score - x.score; });
				let repAddr = data[0].account;
				if (!repAddr) repAddr = data[0].address;
				if (repAddr) ccc[symbol].representative = repAddr;
			});
		}).catch(function() { console.error("Using default rep")});
		representative = ccc[symbol].representative;
	}
	
	return await blockInfoFetch.then(async function(blockInfo) {
		if (!blockInfo) return false;
		return await postBlock(symbol, 'receive', workInput, previous, representative, (BigInt(oldBalance) + BigInt(blockInfo.amount)).toString(), hash);
	});
});};
	
ccc['XNO'].sendTo = function(destination, amt) { return enqueue('XNO', async function() { 
	// check frontier
	let frontierBlock = await fetchFrontier("XNO");
	if (!frontierBlock) return false;
	
	return await postBlock("XNO", 'send', frontierBlock.hash, frontierBlock.hash, frontierBlock.representative, 
		(BigInt(frontierBlock.balance) - BigInt(amt)).toString(), destination);
}); }

ccc['XNO'].createBlock = function(secretKey, data) {
	if (typeof data.work === 'undefined') throw new Error('Work is not set');
	if (!XNO.checkAddress(data.representative)) throw new Error('Representative is not valid');

	let correctedPrevious = data.previous;
	if (correctedPrevious === null) correctedPrevious = BLANK_HASH;

	let linkIsAddress = false;
	let correctedLink = data.link;
	if (correctedLink === null) correctedLink = BLANK_HASH;
	else if (XNO.checkAddress(correctedLink)) linkIsAddress = true;
	if (correctedPrevious === BLANK_HASH && (linkIsAddress || correctedLink === BLANK_HASH)) throw new Error('Block is impossible');

	let publicKey = XNO.pubFromPriv(secretKey);
	let linkBytes = hexToByteArray(correctedLink);
	if (XNO.checkAddress(correctedLink)) linkBytes = hexToByteArray(XNO.pubFromAddr(correctedLink));
	
	const context = blake2bInit(32)
	blake2bUpdate(context, STATE_BLOCK_PREAMBLE_BYTES)
	blake2bUpdate(context, hexToByteArray(publicKey))
	blake2bUpdate(context, hexToByteArray(correctedPrevious))
	blake2bUpdate(context, hexToByteArray(XNO.pubFromAddr(data.representative)))
	blake2bUpdate(context, hexToByteArray(BigInt(data.balance).toString(16).padStart(32, '0')))
	blake2bUpdate(context, linkBytes)
	const hashBytes = blake2bFinal(context)
	
	const block = {
		type: 'state',
		account: XNO.addrFromPub(publicKey),
		previous: correctedPrevious,
		representative: data.representative,
		balance: data.balance,
		link: correctedLink,
		link_as_account: XNO.addrFromPub(correctedLink),
		work: data.work,
		signature: byteArrayToHex(signDetached(hashBytes, hexToByteArray(secretKey))),
	}
	return { hash: byteArrayToHex(hashBytes), block };
}

ccc['XNO'].getAccountInfo = function() { 
	return post(ccc['XNO'].server, {action: 'account_info', pending: true, representative: true, account: XNO.address}).then(function(accountInfo) {
		if (accountInfo && !accountInfo.frontier) {
			accountInfo.balance = "0";
			accountInfo.detail = "Unopened account.";
		} 
		return accountInfo;
	});
};

function enqueue(symbol, func) {
	ccc[symbol].queue = ccc[symbol].queue.then(func);
	return ccc[symbol].queue;
}

async function findWork(workInput, subtype) {
	if (!workInput) {
		workInput = XNO.publicKey;
		let frontierBlock = await fetchFrontier('XNO');
		if (frontierBlock) workInput = frontierBlock.hash;
	}
	
	let rawWorkThreshold = await post(ccc['XNO'].server, { action: 'active_difficulty' });
	let difficulty = rawWorkThreshold.network_current;
	if (subtype == 'receive') difficulty = rawWorkThreshold.network_receive_current;
	
	let work = null;
	let localWork = getLocalJSON("localWork") || {};
	if (localWork[XNO.address] && localWork[XNO.address].workInput == workInput && localWork[XNO.address].difficulty == difficulty) {
		work = localWork[XNO.address].work;
		console.warn("Using local work!!", work);
	} else {
		let i = 0;
		while (!work && ccc['XNO'].powArray[i]) {
			let prework = (await post(ccc['XNO'].powArray[i], {action: 'work_generate', hash: workInput, difficulty}));
			work = prework && prework.work;
			console.warn("Generating REMOTE work:", work, i, ccc['XNO'].powArray[i]);
			i++;
		}
		if (!work) console.warn("All REMOTE work attempts failed...");
	}
	
	if (work) localWork[XNO.address] = {work, workInput, difficulty};	
	setLocalJSON("localWork", localWork);
	return work;
}

async function postBlock(symbol, subtype, workInput, previous, representative, balance, link) {
	let work = await findWork(workInput, subtype);
	if (!work) {	
		showMsg("Proof-of-work failed. Amount NOT processed; try again later.");
		return false;
	}
	
	let block = ccc[symbol].createBlock(XNO.privateKey, { work, previous, balance, representative: representative.replace('ban_', 'nano_'), link: link.replace('ban_', 'nano_') });
	let formData = {action: 'process', json_block: true, subtype: subtype, block: block.block};
	post(ccc[symbol].server, formData);
	
	return new Promise(async function(resolve, reject) {
		let counter = 0;
		waitCheckHash();
		function waitCheckHash() {
			setTimeout(async function() {
				let blockInfo = await ccc[symbol].getBlock(block.hash);
				if (blockInfo && blockInfo.confirmed == "true") resolve(block.hash);
				else if (counter < 15) {
					counter++;
					waitCheckHash();
				} else {
					showMsg("Transfer seems to have failed or is delayed.");
					resolve();
				}
			}, 1000);
		}
	});
}

async function fetchFrontier(symbol) {
	let accountInfo = await ccc[symbol].getAccountInfo();
	if (!accountInfo || !accountInfo.frontier) return false;
	let res = await ccc['XNO'].getBlock(accountInfo.frontier);
	
	if (!res) return false;
	let fetchedFrontierBlock = res.contents;

	let producedFrontierBlock = ccc[symbol].createBlock(XNO.privateKey, {
		work: fetchedFrontierBlock.work,
		previous: fetchedFrontierBlock.previous,
		representative: accountInfo.representative.replace('ban_', 'nano_'),
		balance: accountInfo.balance,
		link: fetchedFrontierBlock.link
	}).block;	
	if (fetchedFrontierBlock.signature != producedFrontierBlock.signature) {
		console.error(fetchedFrontierBlock);
		console.error(producedFrontierBlock);
		alert("Frontier block failed verification. This should NOT happen.");
		return false;
	}
	fetchedFrontierBlock.hash = accountInfo.frontier;
	return fetchedFrontierBlock;
}

function rawFromUnit(symbol, str) {
	let shift = ccc[symbol].shift;
	let parts = str.toString().split(".");	
	let fraction = '';
	if (parts.length > 1) fraction = parts[1];
	while (fraction.length < shift) {
		fraction += '0';
	}
	return `${parts[0]}${fraction}`;
}

function unitFromRaw(symbol, str) {
	let shift = ccc[symbol].shift;
	let n = str.toString();	
	while (n.length < shift + 1) {
		n = '0' + n;
	}
	let whole = n.substring(0, n.length - shift);
	let cut = 0;
	while (n[n.length - 1 - cut] == '0' && cut < shift - 2) cut++;
	let fraction = n.substring(n.length - shift, n.length - cut);
	return whole + '.' + fraction;	
}

async function sendMoney(read) {
	let but = D('sendButton');
	let inputElt = D('sponsorInput');
	let destaddr = D('theirAddress').textContent;
	let threshold = D('theirThreshold').textContent;
	let them = D('theirFunName').textContent;
	if (read) {
		but = D('postSendButton');
		inputElt = D('postSponsorInput');
		destaddr = D('postTheirAddress').textContent;
		threshold = D('postTheirThreshold').textContent;
		them = D('postTheirFunName').textContent;
	}
	
	let overRide = (threshold.substring(1, 2) == "-");
	
	if (inputElt.validationMessage == "Please enter a number." || inputElt.value <= 0) {
		showMsg("Enter a positive value.");
		flash(inputElt);
	} else {
		let symbol = "XNO";
		let amt = inputElt.value;
			
		but.disabled = true;
		let totalAmt = BigInt(rawFromUnit(symbol, amt));
		let balance = BigInt(rawFromUnit(symbol, D('balance').textContent));
		let safetyMax = BigInt(rawFromUnit(symbol, hardMax));
		if (totalAmt > safetyMax) showMsg("Limit for built-in wallet: " + hardMax + " XNO");
		else if (totalAmt > balance) showMsg("Insufficient funds.");
		else {
			let confirmMessage = "Sponsor less than amount for premium content?";
			if (!overRide && totalAmt > BigInt(rawFromUnit(symbol, threshold))) confirmMessage = "Sponsor more than amount for premium content?";
			if ((overRide || totalAmt == BigInt(rawFromUnit(symbol, threshold))) || confirm(confirmMessage)) {
				if (!overRide && totalAmt >= BigInt(rawFromUnit(symbol, threshold))) showMsg("Sponsoring \'" + them + "\'...", null, true);
				else showMsg("Tipping \'" + them + "\'...", null, true);
				let sendResp = await ccc[symbol].sendTo(destaddr, totalAmt.toString());
				if (sendResp) {
					console.log(sendResp);
					flash(D('balance'), unitFromRaw(symbol, BigInt(rawFromUnit(symbol, D('balance').textContent)) - totalAmt));
					
					if (!overRide && totalAmt >= BigInt(rawFromUnit(symbol, threshold))) {
						showMsg("Sponsored \'" + them + "\' with " + amt + " " + symbol + "! Premium content now available.");
						if (ws) ws.emit('sponsor', {userid:destaddr, blockid:sendResp, amt});
					} else showMsg("Tipped \'" + them + "\' " + amt + " " + symbol + "!");
					
					inputElt.value = "";
					refreshBalance(symbol);
				}
			}
		}
		but.disabled = false;
	}
}

function refreshBalance(symbol) {	
	if (!symbol) symbol = "XNO";
	ccc[symbol].getAccountInfo().then(async function(accountInfo) {
		if (!XNO.address) return false;
		
		if (!accountInfo) {
			flash(D('balance'), "??");
			return false;
		}
		
		if (accountInfo.balance !== undefined) flash(D('balance'), unitFromRaw(symbol, accountInfo.balance));
		else flash(D('balance'), "??");
		// if (accountInfo.pending !== undefined) flash(D(`${symbol}-balance-pending`), unitFromRaw(symbol, accountInfo.pending));
		
		let data = await ccc[symbol].getPending();
		if (data) {
			let count = 0;
			for (const block in data.blocks) {
				await ccc[symbol].receive(block);
				count++;
			}
			if (count) {
				refreshBalance(symbol);
				return accountInfo;
			}
		}
		if (unitFromRaw(symbol, accountInfo.balance) != 0) findWork();
	});
}

// Global variables and macros; and initializers ///////////////////////////////////////////////////////////////////////

var readPostid = "";
var readPostContent = "";
var readPostWall = false;
var editPostid = "";
var editPostContent = "";
var editPostPending = false;
var usingRAM = false;
var backList = [];
var browseURL = {};
var currentTitle = "";

var DOMdisplayNameQueue = {};

var displayNameCache = {};
var colorCache = {};
var postCache = {};
var userCache = {};
var browseCache = {};
var noteCount = 0;
var iframes = [];
var youtubes = [];

const enc = new TextEncoder();
const dec = new TextDecoder();
const imgurl = /src="https:\/\/[a-zA-Z0-9;:=%&/~_:\-\.,\?\(\)\+]+"/;
const imgurl2 = /src="data:image\/png;base64,[a-zA-Z0-9;:=%&/~_:\-\.,\?\(\)\+]+"/;

var scrollCache = {browse:0, read:0, write:0};
var readPanelButtons = [D("subscribe2"), D("sponsor2"), D("comment")];

const adj = ["Disillusioned", "Nihilistic", "Disenchanted", "Embittered", "Worldly", "Embattled", "Cynical", "Skeptical", "Contemplative", 
				"Introspective", "Meditative", "Pensive", "Philosophical", "Stoic", "Apathetic", "Analytical", "Scholarly", "Erudite", "Composed", "Detached", "Problematic", 
				"Disruptive", "Grave", "Hysterical", "Impetuous", "Sagacious", "Candid", "Logical", "Enterprising", "Egotistic", "Resolute", "Pretentious", "Sophisticated", "Sincere", 
				"Thoughtful", "Diligent", "Chaotic", "Lawless", "Anarchic"];
const animals = ["Puppy", "Kitten", "Bunny", "Hamster", "Panda", "Otter", "Hedgehog", "Penguin", "Squirrel", "Turtle", "Koala", "Hatchling", "Kit", "Joey", "Fledgling", 
					"Fawn", "Foal", "Calf", "Cub", "Colt", "Piglet", "Eaglet", "Owlet"];

var url = new URL(window.location);						
var possibleOrigins = ["https://brewri.github.io"];

var serverURL = 'wss://brewri-server-stg.fly.dev';
//var serverURL = 'wss://impuremaths.herokuapp.com';
var ws;
setupWebsocket(true);

let localSeed = localStorage.getItem("localSeed");
if (localSeed) inputEvent(D("seed"), localSeed);

url.search = new URLSearchParams({postid:"nano_3iqcmnezofaufndmmgiykhoab6f3q45pqx1t9jqoi7g81n7qmh1tbe5pyfq3-1670977572136"});

D('abtLink').href = url;
D('abtLink').onclick = function() {
	event.preventDefault();
	event.stopPropagation();
	loadURL(new URL(D('abtLink').href));
}

cancelPost();
loadURL();

// Websocket code ///////////////////////////////////////////////////////////////////////

function setupWebsocket(fresh) {
	ws = new WebSocket(serverURL);
	ws.customEvents = {};
	ws.on = function(cueName, eventAction) { ws.customEvents[cueName] = eventAction; };
	ws.emit = function(cueName, payload) { 
		if (ws.readyState == 1) ws.send(JSON.stringify({cueName, payload})); 
		return (ws.readyState == 1);
	};
	
	// Standard commands
	ws.onclose = function() { setupWebsocket(); }
	ws.onopen = function() { 
		console.log("Connected to server!"); 
		if (fresh) loadURL();
		if (XNO.address) {
			let ts = Date.now();
			ws.emit('authenticateUser', {userid: XNO.address, ts, signature:XNO.sign(ts, XNO.address)});
		}
	};
	ws.onmessage = function(event) {
		let data;
		try { data = JSON.parse(event.data); }
		catch { 
			console.error("Unparseable server message.")
			console.error(event.data);
			return false;
		}			
		if (data && data.cueName && ws.customEvents[data.cueName]) ws.customEvents[data.cueName](data.payload);
		else {
			console.error("Unrecognized server message.")
			console.error(event.data);
		}
	};

	// Custom commands ////////////////////////////////////////////////////////
	
	ws.on('authenticateUserResponse', function(data) {
		clearDOM(D('subscriptions'));
		if (XNO.address) makeSubLi(XNO.address);
		if (data.edges) {
			data.edges.sort(function(x, y) { 
				if (x.lastpublishedts && !y.lastpublishedts) return -1;
				if (!x.lastpublishedts && y.lastpublishedts) return 1;
				return y.lastpublishedts - x.lastpublishedts; 
			});
			for (let i = 0; i < data.edges.length; i++) {
				makeSubLi(data.edges[i].userid, data.edges[i]);
			}
		}		
		receiveDOMdisplayName(data);
		
		clearDOM(D('notifications'));
		D('notificationHeading').textContent = "Activity";
		console.log(data);
		noteCount = data.notifCounter || 0;
		setTabTitle(false, true);
		if (data.notifications) {
			data.notifications.sort(function(x, y) { return x.timestamp - y.timestamp; });
			for (let i = 0; i < data.notifications.length; i++) {
				makeNoteLi(data.notifications[i]);
			}
		}
		
		clearDOM(D('library'));
		if (data.library) {
			data.library.sort(function(x, y) { return x.pushedts - y.pushedts; });
			for (let i = 0; i < data.library.length; i++) {
				cachePost(data.library[i]);
				updateLibLi(data.library[i].postid, data.library[i].lastaccessedts, data.library[i].pushedts);
			}
		}
		requestNames();
		
		if (readPostWall) {
			console.log("Trying to clear a wall");
			fillPost(readPostid, false, true);
		}
	});
	
	ws.on('updateNotificationResponse', function(data) { 
		if (data) {
			makeNoteLi(data); 			
			requestNames();
		}
	});
	
	ws.on('queryTagCountsResponse', function(data) {
		clearDOM(D('popularTags'));
		let tagElt = make('a', 'Recent');
		tagElt.style = "flex-shrink:0; cursor:pointer; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:250px; font-weight:600; color:#333";
		tagElt.onclick = function() { queryBrowse(); };
		D('popularTags').appendChild(tagElt);
		
		for (let tag in data) {
			if (data[tag] > 0) {
				let tagElt = make('a', tag); // " • " + tag);
				tagElt.style = "flex-shrink:0; margin-left:20px; cursor:pointer; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:250px";
				tagElt.onclick = function() { queryBrowse({tag}); };
				D('popularTags').appendChild(tagElt);
			}
		}
	});
	
	ws.on('queryUsersResponse', function(data) { 
		for (let i = 0; i < data.length; i++) receiveDOMdisplayName(data[i]);
	});
	
	ws.on('queryPostsRecentResponse', function(data) { fillBrowseList(data); });	
	ws.on('queryTagResponse', function (data) { fillBrowseList(data); });	
	ws.on('queryPostsFromUser', function (data) {
		let update = (!userCache[data.user.userid] || JSON.stringify(userCache[data.user.userid].content) != JSON.stringify(data.user.content));
		if (data.user && !data.user.userid) fillBrowseList([]);
		else if (D('browseHeading').title == data.user.userid) fillBrowseList(data.posts);
		if (data.user.userid) {
			userCache[data.user.userid] = data.user;
			fillBio(data.user.userid, !update);
			if (D(data.user.userid + "-time")) D(data.user.userid + "-time").style = "font-size:0.85em; color:#888";
			
			let readid = readPostid.split("-")[0];
			if (readid == data.user.userid && userCache[readid].sponsor_price) D('postTheirThreshold').textContent = userCache[readid].sponsor_price;
		}
	});
	
	ws.on('queryPostChainResponse', function(data) { 
		let chain = [];
		let hasEditPost = false;
		for (let x in data) {
			cachePost(data[x], chain);
			chain.push(data[x].postid);
			if (editPostid == data[x].postid) hasEditPost = true;
		}
		if (hasEditPost && editPostPending) fillEdit(editPostid, true); 
		else if (readPostid) fillPost(readPostid, true, true);
		requestNames();
	});
	
	ws.on('updateUserResponse', function (data) {
		userCache[data.userid] = data;
		fillBio(data.userid);		
	});
	
	ws.on('updatePostResponse', function(data) { 
		cachePost(data);
		scrollCache.read = 0;
		fillPost(data.postid);
		cancelPost(true);
	});
	
	ws.on('updateCommentResponse', function(data) {	addComment(data); });
	
	ws.on('subscribeResponse', function(data) {	console.log(data); });
	
	ws.on('sponsorResponse', function(data) {
		console.log(data);
		makeSubLi(data.userid2, data);
		D(data.userid2).scrollIntoView({behavior: "smooth", block:"nearest"});
		
		if (readPostWall && D('read').style.display != 'none') {
			console.log("Trying to clear a wall");
			fillPost(readPostid, false, true);
		}
	});
}


// Server data reception ///////////////////////////////////////////////////////////////////////

function cachePost(metaData, chain) {
	metaData.postid = metaData.postid || metaData.userid + "-" + metaData.createdts.toString();	
	if (!metaData.userid) {
		let split = metaData.postid.split("-");
		metaData.userid = split[0];
		metaData.createdts = parseInt(split[1]);
	}
	
	postCache[metaData.postid] = postCache[metaData.postid] || {};
	let cacheData = postCache[metaData.postid];

	cacheData.title = metaData.title;
	cacheData.userid = metaData.userid;
	cacheData.createdts = metaData.createdts;
	cacheData.postid = metaData.postid;
	if (metaData.modifiedts) cacheData.modifiedts = metaData.modifiedts;

	if (metaData.content) {	
		if (!cacheData.content || typeof metaData.content === "string" || cacheData.content.length != cacheData.content.length) cacheData.content = metaData.content;
		else {
			cacheData.content.length = metaData.content.length;
			for (let i = 0; i < metaData.content.length; i++) {
				if (metaData.content[i].content) cacheData.content[i] = metaData.content[i];
			}
		}
	}
	if (metaData.tags) cacheData.tags = metaData.tags;
	if (metaData.comments) cacheData.comments = metaData.comments;
	if (metaData.prev_) cacheData.prev_ = metaData.prev_;
	if (metaData.next_) cacheData.next_ = metaData.next_;
	if (metaData.wall) cacheData.wall = metaData.wall;	
	if (chain) cacheData.chain = chain;
}

function receiveDOMdisplayName(data) {
	let {userid, displayname, color} = data;
	if (displayname) displayNameCache[userid] = displayname;
	else delete displayNameCache[userid];	
	if (color) colorCache[userid] = color;
	else delete colorCache[userid];
	
	if (DOMdisplayNameQueue[userid]) {
		for (let j = 0; j < DOMdisplayNameQueue[userid].length; j++) {
			let elt = DOMdisplayNameQueue[userid][j];
			elt.textContent = funName(userid);
			if (elt != D('displayName') && elt != D('browseHeading')) elt.style.color = funColor(userid);
		}
	}
	delete DOMdisplayNameQueue[userid];	
	
	if (userid && new URLSearchParams(window.location.search).get('userid') == userid) setTabTitle(funName(userid));
	
	if (userid == XNO.address && D('bioEditor').style.display == "none") {
		D('leftSidebar').style.backgroundColor = "hsl(" + funColor(XNO.address, false, true) + ", 55%, 80%)";
		setCSS('--hue', funColor(XNO.address, false, true));
	}
}

function queueDOMdisplayName(userid, elt, black) {
	elt.title = userid;
	elt.textContent = funName(userid);
	elt.style.fontWeight = "600";
	if (!black) elt.style.color = funColor(userid);	
	if (!DOMdisplayNameQueue[userid]) DOMdisplayNameQueue[userid] = [elt];
	else DOMdisplayNameQueue[userid].push(elt);
}

function requestNames() {
	let userids = [];	
	for (let name in DOMdisplayNameQueue) {	userids.push(name);	}
	if (ws && userids.length) ws.emit('queryUsers', {userids});
}

// Central window fill routines ///////////////////////////////////////////////////////////////////////

function queryBrowse(label, automatic, passive) {
	label = label || {};
	let {userid, tag} = label;
	browseURL = label;
	closeBioEditor();
	if (active('sponsor')) sponsorHandler();
	D('toggleBrowse').style.display = "";
	D('bioPreview').style.display = "";
	
	D('theirFunName').style.color = "";	
	D('theirFunName').textContent = "\xa0-\xa0";
	D('theirFunName').title = "";
	D('theirAddress').textContent = "\xa0-\xa0";
	D('theirThreshold').textContent = "\xa0-\xa0";
	
	if (D('browseHeading').title) {
		if (D(D('browseHeading').title)) removeActiveBar(D(D('browseHeading').title));
		if (D("tag-" + D('browseHeading').title)) removeActiveBar(D("tag-" + D('browseHeading').title));
	}
	
	D('profileBut').style.display = "none";
	D('sendButton').disabled = true;
	D('sponsor').disabled = true;
	if (userid) {		
		if (userid == XNO.address) D('profileBut').style.display = "";
		else if (XNO.address) D('sendButton').disabled = false;
		D('sponsor').disabled = false;
		queueDOMdisplayName(userid, D('theirFunName'));
		D('theirAddress').textContent = userid;
		if (D(userid)) activeBar(D(userid));
		
		queueDOMdisplayName(userid, D('browseHeading'), true);
		fillBio(userid);
	} else if (tag) {			
		if (D("tag-" + tag)) activeBar(D("tag-" + tag));
		
		D('browseHeading').title = tag;
		D('browseHeading').textContent = tag;
		D('bio').textContent = "An unmoderated tag."
	} else {	
		D('bioPreview').style.display = "none";
		D('toggleBrowse').style.display = "none";
		
		D('browseHeading').title = "Recent";
		D('browseHeading').textContent = "Recent";
		D('bio').textContent = "The trickle of recent posts."
	}
	
	if (browseCache[D('browseHeading').title]) fillBrowseList(browseCache[D('browseHeading').title]);
	else D('browseList').style.opacity = "0.6";
	
	if (!(automatic && browseCache[D('browseHeading').title]) && ws && ws.readyState == 1) {
		D('loadingMsg').style.display = "";
		if (userid) ws.emit("queryPostsFromUser", label);
		else if (tag) ws.emit("queryTag", label);
		else ws.emit('queryPostsRecent');
		
		if (!(userid || tag) || D('popularTags').children.length < 2) ws.emit('queryTagCounts');
	}
	
	if (!passive) loadPanel('browse');
	if (active('toggleBrowse')) D('toggleBrowse').click();
}

function fillPost(postid, automatic, passive) {
	let userid = postid.split("-")[0];
	let createdts = parseInt(postid.split("-")[1]);	
	
	if (readPostid != postid) {
		if (D('commentContent').value.length && !confirm("Clear comment draft?")) return false;
		D('commentContent').style.display = 'none';
		D('commentContent').value = "";
		D("comment").textContent = "Comment";
		
		if (active('sponsor2')) postSponsorHandler();
		
		D('readTitle').onclick = function() { ws.emit('queryPostChain', {userid, createdts}); }
		D('readTitle').textContent = "Loading...";
		D('readContent').innerHTML = "<i>Loading...</i>";	
	
		// handle left bars
		if (readPostid && D(readPostid)) removeActiveBar(D(readPostid));
		if (readPostid && D(readPostid + "-disc")) removeActiveBar(D(readPostid + "-disc"));
		if (D(postid)) activeBar(D(postid));
		if (D(postid + "-disc")) activeBar(D(postid + "-disc"));
	}
		
	queueDOMdisplayName(userid, D('author'));
	queueDOMdisplayName(userid, D('postTheirFunName'));
	D('postTheirAddress').textContent = userid;
	if (userCache[userid] && userCache[userid].sponsor_price) D('postTheirThreshold').textContent = userCache[userid].sponsor_price;
	else {
		D('postTheirThreshold').textContent = "\xa0-\xa0";		
		if (ws && ws.readyState == 1) ws.emit("queryPostsFromUser", {userid});
	}
	
	while (D('tags').children.length > 1) remove(D('tags').lastElementChild);
	
	D('creation').textContent = unixToDate(createdts);
	D('creation').title = unixToTime(createdts);
	D('modification').textContent = "";
	D('modification').title = "";
	D('modification').style.display = "none";
	
	clearDOM(D('readComments'));
	clearDOM(D('mapul'));	
	let metaData = postCache[postid];
	if (metaData) {
		D('readTitle').textContent = metaData.title;		
		if (metaData.tags) {
			for (let i = 0; i < metaData.tags.length; i++) {
				D('tags').appendChild(tagLabel(metaData.tags[i]));
			}
		}		
		if (metaData.modifiedts && unixToDate(metaData.modifiedts) != unixToDate(createdts)) {
			D('modification').textContent = " •\xa0" + unixToDate(metaData.modifiedts);
			D('modification').title = unixToTime(metaData.modifiedts);
			D('modification').style.display = "";
		}
		
		// content
		if (metaData.content) {
			let theNewContent = JSON.stringify(metaData.content);
			if (readPostid != postid || theNewContent != readPostContent) {
				readPostContent = theNewContent;
				if (typeof metaData.content === "string") D('readContent').textContent = metaData.content;
				else fillContent(D('readContent'), metaData.content, metaData.wall, userid);
			}
		}
		
		// comments
		if (metaData.comments) {
			metaData.comments.sort(function(x, y) {	return parseInt(x.commentid.split("-")[1]) - parseInt(y.commentid.split("-")[1]); });		
			for (let i = 0; i < metaData.comments.length; i++) { addComment(metaData.comments[i]); }	
		}
		
		if (metaData.chain) {
			for (let i = 0; i < metaData.chain.length; i++) {				
				let postli = make('li');
				postli.style.whiteSpace = "nowrap";
				postli.appendChild(fullLabel(metaData.chain[i]));
				if (postid == metaData.chain[i]) activeBar(postli);
				D('mapul').appendChild(postli);
			}
		}
	}
	
	readPostid = postid;
	if (XNO.address) buttonLogout(false);
	
	// scrollCache.read = 0;
	if (!(automatic && postCache[postid])) ws.emit('queryPostChain', {userid, createdts});
	let lastaccessedts = (!automatic && Date.now()) || 0;
	//if (!automatic && !D(postid) && XNO.address && ws) ws.emit('updateLibrary', { posts: [{ userid, createdts, pushedts:lastaccessedts, lastaccessedts }] });
	if (!automatic || D(postid)) updateLibLi(postid, lastaccessedts);
	
	if (!passive) loadPanel('read');
	if (active('toggleRead')) D('toggleRead').click();	
}

function fillEdit(postid, confirmation) {	
	if (!confirmation && !cancelPost()) return false;
	
	if (!postid) postid = readPostid;
	let userid = postid.split("-")[0];
	let createdts = parseInt(postid.split("-")[1]);
	D('editid').style.display = "";
	D('creationEdit').textContent = unixToDate(createdts);
	D('creationEdit').title = unixToTime(createdts);
	
	D('publishButton').textContent = "Update";
	D('clearButton').textContent = "Cancel";
	
	let theNewContent = "";
	let metaData = postCache[postid];	
	if (metaData) {	
		D('postTitle').value = metaData.title;
		if (metaData.tags) {
			for (let i = 0; i < metaData.tags.length; i++) {
				D('set-tag').value = metaData.tags[i];
				addTag();
			}
		}
		if (metaData.modifiedts && unixToDate(metaData.createdts) != unixToDate(metaData.modifiedts)) {
			D('modificationEdit').textContent = " •\xa0" + unixToDate(metaData.modifiedts);
			D('modificationEdit').title = unixToTime(metaData.modifiedts);
		}	
		
		url.search = new URLSearchParams({postid: metaData.prev_});
		if (metaData.prev_) {
			inputEvent(D('set-prev'), url.href);
			D("recip-prev").classList.remove('active');
		}
		url.search = new URLSearchParams({postid: metaData.next_});	
		if (metaData.next_) {
			inputEvent(D('set-next'), url.href);
			D("recip-next").classList.remove('active');
		}
		
		
		// content
		if (metaData.content) {
			let theNewContent = JSON.stringify(metaData.content);
			if (editPostid != postid || theNewContent != editPostContent) {
				editPostContent = theNewContent;
				if (typeof metaData.content === "string") {
					clearDOM(D('postEditor'));	
					appendBlockEditor().firstChild.value = metaData.content;
				} else {
					fillEditorContent(metaData.content, D('postEditor'));		
					if (metaData.wall) {
						for (let i = 0; i < metaData.wall.length; i++) {
							toggle(D('postEditor').children[metaData.wall[i]].children[1].firstElementChild);
						}
					}
				}
			}
		}
	}
	
	editPostid = postid;
	editPostPending = !confirmation;
	if (!confirmation) {
		ws.emit('queryPostChain', { userid: postid.split("-")[0], createdts: parseInt(postid.split("-")[1]) });
		scrollCache.write = 0;
	}
	
	loadPanel('write');
	if (active('toggleEdit')) D('toggleEdit').click();
}

function setTabTitle(str, reset) {
	if (reset) str = currentTitle;
	else currentTitle = str;
	let prepend = "";
	if (noteCount) prepend = "(" + noteCount + ") ";
	if (str) document.title = prepend + str + " - Brewri";
	else document.title = prepend + " Brewri";
}

function loadPanel(type, useRAM, goingBack) {
	let prevType = "browse";
	for (let panelType in scrollCache) {
		if (D(panelType).style.display != 'none') {
			prevType = panelType;
			scrollCache[panelType] = Math.ceil(D('centralWindowScroller').scrollTop);
			if (type == prevType) scrollCache[panelType] = 0;
		}
		D(panelType).style.display = 'none';
		D(panelType + 'Button').classList.remove('active');
	}
	
	if (type != prevType) {
		let newYoutubes = [];
		for (let i = 0; i < youtubes.length; i++) {
			if (youtubes[i].parentNode && youtubes[i].contentWindow) {
				youtubes[i].contentWindow.postMessage('{"event":"command","func":"' + 'pauseVideo' + '","args":""}', '*');
				newYoutubes.push(youtubes[i]);
			}
		}
		youtubes = newYoutubes;
	}
	
	D(type).style.display = "flex";
	D(type + "Button").classList.add('active');
	popularTags.classList.add("desktop");
	
	useRAM = (useRAM && type != prevType);
	if (useRAM && !goingBack) backList.push(prevType);	
	function changeHistory() {
		if (useRAM && usingRAM) window.history.replaceState(null, "", url);
		else {
			window.history.pushState(null, "", url);
			backList = [];
			usingRAM = useRAM;
		}
	}
	
	let params = new URLSearchParams(window.location.search);
	if (type == "read") {
		url.search = new URLSearchParams({postid:readPostid});		
		if (params.get('postid') != readPostid) changeHistory();

		if (postCache[readPostid]) setTabTitle(postCache[readPostid].title);
		else setTabTitle("Read");
	} else if (type == "browse") {		
		url.search = new URLSearchParams(browseURL);
		if (params.get('userid') != browseURL.userid || params.get('tag') != browseURL.tag || params.get('postid') != null || params.get('editid') != null) changeHistory();
		
		if (browseURL.userid) setTabTitle(funName(browseURL.userid));
		else if (browseURL.tag) setTabTitle(browseURL.tag);
		else setTabTitle("");
		
		D(type).style.display = "";
		popularTags.classList.remove("desktop");
	} else {
		url.search = new URLSearchParams({editid:editPostid});	//url = new URL(window.location);
		if (params.get('editid') != editPostid) changeHistory();
		
		if (postCache[editPostid]) setTabTitle("Updating \'" + postCache[editPostid].title + "\'");
		else if (editPostid) setTabTitle("Update");
		else setTabTitle("Write");
	}

	D('centralWindowScroller').scrollTo(0, scrollCache[type]);	
	D('centralWindow').scrollIntoView({behavior: "smooth", block:"nearest"});
}

// Fill helpers ///////////////////////////////////////////////////////////////////////

function fillBrowseList(data) {
	if (D('browseHeading').title) browseCache[D('browseHeading').title] = data;
	D('loadingMsg').style.display = "none";
	clearDOM(D('browseList'));
	D('browsePlaceholder').style.display = "none";
	D('browseList').style.opacity = "";
	
	if (data) {
		data.sort(function(x, y) { return y.createdts - x.createdts; });
		for (let i = 0; i < data.length; i++) {	
			cachePost(data[i]);				
			let mediaBox;
			if (typeof postCache[data[i].postid].content !== "string" && postCache[data[i].postid].content) {
				for (let j = 0; j < postCache[data[i].postid].content.length; j++) {
					let content = postCache[data[i].postid].content[j];
					if (content.type == "image" || content.type == "media" && content.content) {
						mediaBox = fillMediaBox(content.content.trim().split(" "), true);					
						break;
					}		
				}
			}
			
			let postli = make('li');
			postli.id = data[i].postid + "-disc";
			postli.style.marginBottom = "0.85em";			
			postli.appendChild(fullLabel(data[i].postid, "browse", mediaBox));			
			if (readPostid == data[i].postid) activeBar(postli);
			D('browseList').appendChild(postli);
		}
	} else D('browsePlaceholder').style.display = "";
	requestNames();
	// scrollCache.browse = 0;
}

function fillBio(userid, block) {
	let data = userCache[userid];
	if (!data) D('bio').textContent = "Full of possibilities.";
	else {
		if (data.sponsor_price) D('theirThreshold').textContent = data.sponsor_price;
		//else D('theirThreshold').textContent = "1.00";
		if (!block) {
			if (data.bio && data.bio.length) fillContent(D('bio'), data.bio);
			else D('bio').textContent = "Full of possibilities."
		}
		receiveDOMdisplayName(data);
	}
}

function fillContent(elt, content, wall, userid) {
	clearDOM(elt);
	if (elt == D('readContent')) readPostWall = false;
	for (let i = 0; i < content.length; i++) {	
		let jsbox = make("div");
		if (!content[i].content) {
			readPostWall = true;
			let wording = "- Premium content";
			if (content[i].type == "js") wording = "- An applet";
			if (content[i].type == "media") wording = "- Media";
		
			jsbox.style = "text-align:center; margin:20px 0px; padding:30px 10px; font-style:italic";			
			jsbox.appendChild(make('span', wording + " available to "));
			let athlabel = authorLabel(userid);
			athlabel.onclick = function() {	
				event.preventDefault();
				event.stopPropagation();
				// queryBrowse({userid});
				// sponsorHandler();
				if (!active('sponsor2')) postSponsorHandler();
				else D('postSponsorInput').scrollIntoView({behavior: "smooth", block:"nearest"});
			}
			jsbox.appendChild(athlabel);
			jsbox.appendChild(make('span', "'s sponsors -"));
		} else if (content[i].type == "js") {
			jsbox = make("iframe");
			iframes.push(jsbox);
			jsbox.style = "width:100%; height:0px; border-top:0px; border-bottom:0px; border-radius:5px; border-left:4px solid transparent; border-right:0px";
			deselect(jsbox);
			jsbox.onmouseenter = function() { if (jsbox != document.activeElement) partialDeselect(jsbox); }
			jsbox.onmouseleave = function() { if (jsbox != document.activeElement) deselect(jsbox);	}
			jsbox.sandbox = "allow-scripts";
			let str = `<script>window.onload = function() {
				window.parent.postMessage({height:Math.max( document.body.scrollHeight, document.body.offsetHeight, document.body.clientHeight,
				document.body.parentElement.scrollHeight, document.body.parentElement.offsetHeight, document.body.parentElement.clientHeight)}, '*');
			};<` + "/" + `script>`;
			jsbox.srcdoc = content[i].content + str;
		} else if (content[i].type == "image" || content[i].type == "media") {
			let str = content[i].content.trim();			
			jsbox.appendChild(fillMediaBox(str.split(" ")));
			let caption = str.match(/\[(.*)\]/);
			if (!caption && str.indexOf(' ') + 1) {
				caption = str.substring(str.indexOf(' ') + 1);
				if (caption) caption = [ "[" + caption + "]", caption];
			}
			if (caption && caption.length > 1) {
				let capbox = make("div", caption[1]);
				capbox.style = "text-align:center; font-size:0.9em; margin-top:1em"; 
				jsbox.appendChild(capbox);
			}
		} else {
			jsbox.innerHTML = DOMPurify.sanitize(marked.parse(content[i].content));
			
			let relativelinks = jsbox.getElementsByTagName("a");
			for (let i = 0; i < relativelinks.length; i++) {
				if (relativelinks[i].origin == window.location || possibleOrigins.includes(relativelinks[i].origin)) {
					relativelinks[i].onclick = function() {
						event.preventDefault();
						event.stopPropagation();
						loadURL(new URL(relativelinks[i].href));
					}
				}
			}
		}
		
		jsbox.style.marginBottom = "2em";
		elt.appendChild(jsbox);
	}
	
	if (wall) {
		for (let i = 0; i < wall.length; i++) {
			let block = elt.children[wall[i]];
			block.style.opacity = "0.6";
			if (content[wall[i]].content) {
				block.style.transitionProperty = "opacity";
				block.style.transitionDuration = "1s";
				block.style.transitionTimingFunction = "";
				setTimeout(function() { block.style.opacity = ""; }, 0);
			} else {			
				block.style.borderLeft = "4px solid transparent";
				block.style.borderRadius = "5px";
				block.onmouseenter = function() {
					block.style.opacity = "";
					block.style.borderColor = "hsl(var(--hue), var(--butsat), 80%)";
				};
				block.onmouseleave = function() {
					block.style.opacity = "0.6";
					block.style.borderColor = "transparent";
				};			
			}
		}
	}
}

function fillEditorContent(data, elt) {
	clearDOM(elt);	
	if (data && data.length) {
		for (let i = 0; i < data.length; i++) {
			inputEvent(appendBlockEditor(data[i].type, null, elt).firstChild, data[i].content);
		}
	} else appendBlockEditor("text", null, elt);
}
					
function fillMediaBox(mediaURL, preview) {
	let mediaBox;
	if (mediaURL.length) mediaURL = mediaURL[0].split("[");
	if (mediaURL.length) mediaURL = mediaURL[0].trim();
	else mediaURL = "";			
	let match = mediaURL.match(/^.*(youtu\.be\/|vi?\/|u\/\w\/|embed\/|\?vi?=|\&vi?=)([^#\&\?]*).*/);			
	let ext = mediaURL.slice(-4).toLowerCase();	
	
	if (match && match[2].length == 11) {
		mediaBox = make('div');		
		mediaBox.style = "position:relative";
		
		let frame = make('div');
		frame.style = "padding-bottom:56%";	
		mediaBox.appendChild(frame);	
		
		let youtube = make("iframe");
		youtube.style = "border:0px; background-color:black; position:absolute; height:100%; width:100%; top:0px; left:0px;";
		youtube.src = "https://www.youtube.com/embed/" + match[2] + "?modestbranding=1&enablejsapi=1"							
		mediaBox.appendChild(youtube);
		youtubes.push(youtube);
	} else if (ext == ".mp4" || ext == ".ogg" || ext == "webm") {
		mediaBox = make("video");
		mediaBox.controls = true;
		mediaBox.src = mediaURL;
		fileSize(mediaURL);
	} else if (ext == ".mp3" || ext == ".wav") {
		mediaBox = make("audio");
		mediaBox.style = "margin:auto";
		mediaBox.controls = true;
		mediaBox.src = mediaURL;
		fileSize(mediaURL);
	} else {
		mediaBox = make('picture');
		mediaBox.style = "display:flex; justify-content:center";
		
		let imagediv = make("img");
		imagediv.style = "font-style:italic; height:fit-content; margin:auto; max-width:100%; max-height:50vh";
		imagediv.alt = "loading image...";
		mediaBox.appendChild(imagediv);
		fileSize(mediaURL).then(function(size) {
			if (!preview || size < 262144) {
				imagediv.alt = "- missing image -";
				imagediv.src = mediaURL;
			} else if (size > 0) imagediv.alt = "- large image -";
			else imagediv.alt = "- missing image -";
		}).catch(function() { imagediv.alt = "- missing image -"; });
	}						
	mediaBox.style.width = "100%";	
	return mediaBox;
}	

function addComment(commentData) {
	let theComment = D(commentData.commentid);
	if (theComment) theComment.textContent = commentData.content;
	else theComment = make('li', commentData.content);
	theComment.innerHTML = theComment.innerHTML.replace(/([\n]{2,})/g, "<p style='margin:0.9em 0px'></p>");
	
	let dateDiv = timeLabel(parseInt(commentData.commentid.split("-")[1]), commentData.modifiedts);
	dateDiv.id = commentData.commentid + "-date";
	dateDiv.style.color = "#888";
	dateDiv.style.marginLeft = "5px";	
	if (D(commentData.commentid + "-date")) D(commentData.commentid + "-date").replaceWith(dateDiv);
	
	if (theComment.id == commentData.commentid) return false;	
	theComment.id = commentData.commentid;
	theComment.style = "margin-bottom:1em; font-size:0.9em";	
	
	let theLabel = make('div');
	theLabel.style = "font-size:0.85em; overflow:hidden; text-overflow:ellipsis; margin-bottom:0.3em";
	let userid = commentData.commentid.split("-")[0];	
	theLabel.appendChild(authorLabel(userid));
	theLabel.appendChild(dateDiv);

	let editPanel;	
	if (XNO.address == userid) {
		editPanel = make('textarea');
		let editBut = make('a', " • Edit");	
		editBut.style.cursor = "pointer";
		
		let tempContent = commentData.content;
		editPanel.value = tempContent;
		
		editPanel.onfocus = function() { scrollPanel(editPanel); };
		editPanel.style = "height:80px; margin-bottom:5px; margin-top:10px; width:100%; display:none; font-size:0.9em";	
		editPanel.style.fontFamily = "Segoe UI, Source Sans Pro, Roboto, Helvetica, sans-serif";
		
		editPanel.oninput = function() {
			if (editPanel.value) editBut.textContent = " • Publish edit";
			else editBut.textContent = " • Cancel";
		};
		editPanel.onkeyup = function() {
			if (event.keyCode == 27) {
				event.stopPropagation();
				editPanel.value = tempContent;
				editPanel.style.display = "none";
				editBut.textContent = " • Edit";
			}
		}
		
		// editBut.style = "padding:2px 8px; margin:2px; margin-left:10px;";				
		editBut.onclick = function() {
			if (editPanel.style.display) {
				editPanel.style.display = "";
				this.textContent = " • Cancel";
				editPanel.focus();
			} else {
				if (editPanel.value && editPanel.value != tempContent)
					ws.emit('updateComment', {content:editPanel.value, postid: commentData.postid, parentid: commentData.parentid, commentid: commentData.commentid, previd: commentData.previd });
					
				tempContent = editPanel.value;
				editPanel.style.display = "none";
				editBut.textContent = " • Edit";
			}
		};
		theLabel.appendChild(editBut);
	}	
	
	if (commentData.parentid) {
		D(commentData.parentid + "-ul").appendChild(theLabel);	
		if (editPanel) {
			editPanel.placeholder = "Comment...";
			D(commentData.parentid + "-ul").appendChild(editPanel);	
		}
		D(commentData.parentid + "-ul").appendChild(theComment);
	} else {
		let repPanel = make('textarea');
		let repBut = make('button', "Reply");
		
		repPanel.onfocus = function() { scrollPanel(repPanel); };
		repPanel.style = "height:80px; display:none; margin-left:20px; margin-bottom:15px; margin-top:20px; width:calc(100% - 20px); font-size:0.9em";		
		repPanel.style.fontFamily = "Segoe UI, Source Sans Pro, Roboto, Helvetica, sans-serif";
		repPanel.placeholder = "Reply...";
		repPanel.oninput = function() {
			if (repPanel.value) repBut.textContent = "Reply";
			else repBut.textContent = "Cancel";
		};
		repPanel.onkeyup = function() {
			if (event.keyCode == 27 && (!repPanel.value.length || confirm("Delete reply?"))) {
				repPanel.value = "";
				repPanel.style.display = "none";
				repBut.textContent = "Reply";
				event.stopPropagation();
			}
		}					
		
		// reply button
		repBut.style = "font-size:0.85em;";
		repBut.title = commentData.commentid;
		if (!XNO.address) repBut.disabled = true;		
		repBut.onclick = function() {
			if (repPanel.style.display == "none") {
				repPanel.style.display = "block";
				this.textContent = "Cancel";
				repPanel.focus();
			} else {
				repPanel.style.display = "none";
				this.textContent = "Reply";
				let previd = "";
				if (D(commentData.commentid + "-ul").lastElementChild) previd = D(commentData.commentid + "-ul").lastElementChild.id;
				if (repPanel.value) ws.emit('updateComment', {content:repPanel.value, postid:commentData.postid, parentid:commentData.commentid, previd});
				repPanel.value = "";
			}
		};
		
		// future replies
		let ulcomment = make('ul');
		ulcomment.style = "margin-left:20px";
		ulcomment.id = commentData.commentid + "-ul";
		
		let repButHolder = make('div');
		repButHolder.style = "display:flex; justify-content:right; margin-bottom:0.85em;";
		let repLine = make('div');
		repLine.classList.add("horizontalLine");
		repButHolder.appendChild(repLine);
		repButHolder.appendChild(repBut);
		
		if (D('readComments').children.length) D('readComments').insertBefore(repButHolder, D('readComments').firstElementChild);
		else D('readComments').appendChild(repButHolder);
		
		D('readComments').insertBefore(repPanel, D('readComments').firstElementChild);
		D('readComments').insertBefore(ulcomment, D('readComments').firstElementChild);
		D('readComments').insertBefore(theComment, D('readComments').firstElementChild);
		if (editPanel) {
			editPanel.placeholder = "Reply...";
			D('readComments').insertBefore(editPanel, D('readComments').firstElementChild);
		}
		D('readComments').insertBefore(theLabel, D('readComments').firstElementChild);
	}
}

function appendBlockEditor(type, previous, parent) {
	if (!parent) parent = D('postEditor');
	let block = make('div');
	block.tabIndex = "-1";
	block.style.position = "relative";
	let textbox = make('textarea');
	textbox.style = "height:150px; width:100%; tab-size:4; position:relative";	
	textbox.onfocus = function() { scrollPanel(textbox); };
	block.appendChild(textbox);	
	
	let imgur = make('button', "Imgur upload...");
	imgur.style = "position:absolute; right:15px; bottom:57px; font-size:0.85em; display:none";	
	let imgurIn = make('input');
	imgurIn.type = "file";
	imgurIn.accept = "image/*,video/*";
	imgurIn.style.display = "none";	
	imgurIn.addEventListener("change", function() {	handleFiles(imgurIn.files[0]); });
	imgur.onclick = function() { imgurIn.click(); };
	
	textbox.addEventListener("dragenter", function(e) {
		e.stopPropagation();
		e.preventDefault();
	});	
	textbox.addEventListener("dragover", function(e) {
		e.stopPropagation();
		e.preventDefault();
	});
	textbox.addEventListener("drop", function (e) {
		e.stopPropagation();
		e.preventDefault();
		
		if (!active(mediaBut) && !textbox.value.length) mediaBut.click();
		if (active(mediaBut)) {
			let textData = e.dataTransfer.getData("text/html");
			let obj = imgurl.exec(textData);
			if (!obj) obj = imgurl2.exec(textData);		
			if (obj) inputEvent(textbox, obj[0].substring(5, obj[0].length - 1));
			else handleFiles(e.dataTransfer.files[0]);
		}
	});
	
	function handleFiles(file) {
		const xhr = new XMLHttpRequest();
		showMsg("Uploading to Imgur...", null, true);
					
		xhr.open("POST", "https://api.imgur.com/3/image");
		xhr.setRequestHeader("Authorization", "Client-ID ae2fefc03df36fb");			
		xhr.timeout = 10*1000; // 10 seconds
		xhr.onreadystatechange = function() {
			if (this.readyState == 4) {
				if (this.status == 200) {
					try { 
						inputEvent(textbox, JSON.parse(this.responseText).data.link); 
						showMsg("Uploaded!");
					} catch(e) {
						showMsg('Imgur upload failed.');
						console.error(this.responseText);
					}
				} else if (this.status == 400) showMsg('Imgur upload failed.');
				else showMsg('Unable to connect to Imgur.');
			}
		};
		xhr.send(file);
		// const reader = new FileReader();
		// reader.onload = (evt) => { xhr.send(evt.target.result); };			
		// reader.readAsBinaryString(file);
	}
	
	let sponsBut = make('button', "Premium");
	sponsBut.style.marginRight = "5px";
	sponsBut.style.fontSize = "0.85em";
	sponsBut.tabIndex = "-1";
	sponsBut.onclick = function() { toggle(this); }
	
	let mdBut = make('button', "Text");
	mdBut.classList.add("left");
	mdBut.onclick = function() { 
		textbox.title = "text";
		textbox.placeholder = "Text (markdown formatting enabled)...";
		textbox.spellcheck = true;
		textbox.style.fontFamily = "Segoe UI, Source Sans Pro, Roboto, Helvetica, sans-serif";
		textbox.style.color = "";
		if (textbox.value == "<div>\n\n</div>\n\n" + "<script>\n\n</" + "script>") textbox.value = "";
		textbox.onkeydown = "";
		textbox.oninput = "";
		imgur.style.display = "none";
		selectType(this);
	}
	
	let jsBut = make('button');
	
	let jsText = make('span', "HTML/JS");
	let abbrjsText = make('span', "JS");
	jsText.classList.add("desktop");
	abbrjsText.classList.add("mobile");
	abbrjsText.style.position = "initial";
	abbrjsText.style.fontWeight = "initial";
	jsBut.appendChild(jsText);
	jsBut.appendChild(abbrjsText);
	
	jsBut.classList.add("center");
	jsBut.onclick = function() { 	
		textbox.title = "js";
		textbox.placeholder = "HTML (JS scripts enabled)...";
		textbox.spellcheck = false;
		textbox.style.fontFamily = "";
		textbox.style.color = "";
		if (!textbox.value) textbox.value = "<div>\n\n</div>\n\n" + "<script>\n\n</" + "script>";
		addTabbing(textbox);
		textbox.oninput = "";
		imgur.style.display = "none";
		selectType(this);
	};
	
	let mediaBut = make('button', "Media");
	mediaBut.classList.add("right");
	mediaBut.onclick = function() {
		textbox.title = "media";
		textbox.placeholder = "URL to image, audio, or video [optional caption]...\n\n(Supports most images; mp3, wav; mp4, ogg, webm, and Youtube URL)";
		textbox.spellcheck = false;
		textbox.style.fontFamily = "Segoe UI, Source Sans Pro, Roboto, Helvetica, sans-serif";
		if (textbox.value == "<div>\n\n</div>\n\n" + "<script>\n\n</" + "script>") textbox.value = "";		
		if (textbox.value) textbox.style.color = "#888";
		else textbox.style.color = "";
		textbox.onkeydown = "";
		textbox.oninput = function() {
			if (textbox.value) textbox.style.color = "#888";
			else textbox.style.color = "";
		}
		imgur.style.display = "";
		selectType(this);
	};
	
	let delBut = make('button', "✕");
	delBut.style.marginLeft = "15px";
	delBut.classList.add("left");
	delBut.onclick = function() { 
		if (!textbox.value || confirm("Delete element?")) {
			remove(block);		
			if (parent.children.length == 1) parent.firstElementChild.children[1].lastElementChild.lastElementChild.previousElementSibling.disabled = true;
		}
	};
	
	let addBut = make('button', "＋");
	addBut.style.marginLeft = "4px";
	addBut.classList.add("right");
	addBut.onclick = function() { appendBlockEditor("text", block, parent) };

	let buttonPanel = make('div');
	buttonPanel.style = "display:flex; justify-content:right";
	function selectType(elt) {	
		for (let i = 0; i < buttonPanel.children.length; i++) {
			buttonPanel.children[i].classList.remove("active");
		}
		elt.classList.add("active");
		textbox.focus();	
	}
	buttonPanel.appendChild(mdBut);
	buttonPanel.appendChild(jsBut);
	buttonPanel.appendChild(mediaBut);
	buttonPanel.appendChild(delBut);
	buttonPanel.appendChild(addBut);
	
	let buttonParent = make('div');
	buttonParent.style = "margin-top:10px; margin-bottom:20px; display:flex; justify-content:space-between";
	if (parent == D('postEditor')) buttonParent.appendChild(sponsBut);
	else buttonParent.style.justifyContent = "right";
	buttonParent.appendChild(buttonPanel);	
	block.appendChild(buttonParent);
	block.appendChild(imgur);
	
	if (!type) type = "text";
	if (type == "js") jsBut.click();
	else if (type == "image" || type == "media") mediaBut.click();
	else mdBut.click();
	
	if (previous) {
		if (previous.nextElementSibling) previous.parentNode.insertBefore(block, previous.nextElementSibling);
		else previous.parentNode.appendChild(block);
	} else parent.appendChild(block);	
	
	if (parent.children.length == 1) delBut.disabled = true;
	else for (let i = 0; i < parent.children.length; i++) {
		parent.children[i].children[1].lastElementChild.lastElementChild.previousElementSibling.disabled = false;
	}
	for (let i = 0; i < buttonPanel.children.length; i++) {
		buttonPanel.children[i].tabIndex = -1;
	}
	
	// textbox.focus();
	flash(textbox);
	return block;
}

// Label routines ///////////////////////////////////////////////////////////////////////

function fullLabel(postid, type, mediaBox) {
	let data = postCache[postid] || {};
	let userid = postid.split("-")[0];
	let createdts = parseInt(postid.split("-")[1]);	
	
	let postTitle = make('div', data.title || "- missing title -");
	postTitle.title = data.title || "- missing title -";
	postTitle.style = "overflow:hidden; text-overflow:ellipsis;"
	if (type == "browse") postTitle.style.marginBottom = "3px";
			
	// author and tags
	let tags = make('div');
	tags.style = "font-size:0.85em; overflow: hidden; text-overflow:ellipsis;"
	if (mediaBox) {
		tags.style.display = "-webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical;";
		postTitle.style.display = "-webkit-box; -webkit-line-clamp: 3; line-clamp: 3; -webkit-box-orient: vertical;";
	}
	tags.appendChild(authorLabel(userid));	
	if (data.tags) {
		for (let i = 0; i < data.tags.length; i++) {			
			tags.appendChild(tagLabel(data.tags[i]));
		}
	}
	
	// Meta: dates, edit
	let postMeta = make('div');
	postMeta.style = "font-size:0.85em; overflow:hidden; text-overflow:ellipsis; margin:2px 0px;";		
	postMeta.appendChild(timeLabel(createdts, data.modifiedts));
	
	if (data.wall && data.wall.length) postMeta.appendChild(make('span', " • Premium"));
	
	if (userid == XNO.address) {
		let editBut = make('a', " • Update");			
		editBut.onclick = function() {
			event.stopPropagation();
			event.preventDefault();
			fillEdit(postid);
		}
		postMeta.appendChild(editBut);		
	}
	
	// Hover buttons	
	let postLink = make('button', "Link");
	postLink.classList.add("left");
	postLink.style.marginRight = "4px";
	postLink.onclick = function() {
		event.stopPropagation();
		event.preventDefault();
		url.search = new URLSearchParams({postid});
		clickCopy(this, url.href);
	};
	
	let addBut = make('button', "＋");
	addBut.classList.add("right");	
	if (type == "library") {
		addBut.textContent = "✕";
		addBut.onclick = function() {
			event.stopPropagation();
			event.preventDefault();
			remove(label.parentNode);
			if (ws) ws.emit('deleteLibrary', {postid:label.parentNode.id});
			if (!D('library').firstElementChild) D('libraryPlaceholder').style.display = "";
		};	
	} else addBut.onclick = function() {
		event.stopPropagation();
		event.preventDefault();
		if (!D(postid)) {
			updateLibLi(postid);
			if (XNO.address && ws) ws.emit('updateLibrary', { posts: [{ userid, createdts, pushedts:Date.now() }] });
		}
		flash(D(postid));
		D(postid).scrollIntoView({behavior: "smooth", block:"nearest"});
	}
	
	let actions = make('div');
	actions.style = "position:absolute; top:0px; right:0px; display:none; opacity:0.93";
	actions.appendChild(postLink);
	actions.appendChild(addBut);
	
	let label = make('a');
	label.style = "display:flex; overflow:hidden; padding:5px; position:relative; color:#333";
	
	url.search = new URLSearchParams({postid});
	label.href = url;
	let sbdiv = make('div');
	sbdiv.style = "text-overflow:ellipsis; overflow:hidden";
	sbdiv.appendChild(postTitle);
	sbdiv.appendChild(tags);
	sbdiv.appendChild(postMeta);
	label.appendChild(sbdiv);
	if (mediaBox) {
		sbdiv.style.flexBasis = "1px";
		sbdiv.style.flexGrow = 1;	
		
		let sbdiv2 = make('button');
		label.classList.add("parentbutton");
		sbdiv2.classList.add("childbutton");
		sbdiv2.style = "display:flex; flex-basis:1px; flex-grow:1; margin-left:15px; height:169px; border-radius:5px; overflow:hidden; padding:0px";
		sbdiv2.appendChild(mediaBox);		
		label.appendChild(sbdiv2);
	}
	label.appendChild(actions);
	
	label.onmouseenter = function() { if (screen.width > 600 && screen.height > 600) actions.style.display = ""; };
	label.onmouseleave = function() { actions.style.display = "none"; };
	label.onclick = function() {
		event.preventDefault();
		fillPost(postid);
		flash(this.parentNode);
	}
	return label;
}

function tagLabel(tag) {			
	let displayStr = tag;
	if (displayStr.length > 32) displayStr = displayStr.substring(0, 32) + "...";
	let tagElt = make('a', " •\xa0" + displayStr);			
	url.search = new URLSearchParams({tag});
	tagElt.href = url;
	tagElt.onclick = function() {			
		event.preventDefault();
		event.stopPropagation();
		queryBrowse({tag});
	};
	return tagElt;
}

function authorLabel(userid) {
	let postAuthor = make('a');
	postAuthor.style = "font-weight:600";
	url.search = new URLSearchParams({userid});
	postAuthor.href = url;
	queueDOMdisplayName(userid, postAuthor);
	postAuthor.onclick = function() {	
		event.preventDefault();
		event.stopPropagation();
		queryBrowse({userid});
	};	
	return postAuthor;
}

function timeLabel(createdts, modifiedts) {	
	let dateDiv = make('span');
	
	let postDate = make('span', timeSince(createdts));	
	postDate.title = unixToTime(createdts);
	dateDiv.appendChild(postDate);	
	
	if (modifiedts && timeSince(modifiedts) != timeSince(createdts)) {
		let postModified = make('span', " •\xa0" + timeSince(modifiedts));
		postModified.style.fontStyle = "italic";
		postModified.title = unixToTime(modifiedts);
		dateDiv.appendChild(postModified);
	}
	return dateDiv;
}

// Main panel minor UI interaction handlers ///////////////////////////////////////////////////////////////////////

function sponsorHandler() {
	if (active('sponsor')) {
		D('bioSponsor').style.display = "none";
		D('sponsorInput').value = "";
	} else {
		D('bioSponsor').style.display = "";
		// D('sponsorInput').focus();
		flash(D('sponsorInput'));
		if (window.getComputedStyle(D('toggleBrowse')).display != 'none' && D('toggleBrowse').nextElementSibling.nextElementSibling.classList.contains("desktop"))
			D('toggleBrowse').click();
		D('sponsorInput').scrollIntoView({behavior: "smooth", block:"nearest"});
	}
	toggle(D('sponsor'));
}

function postSponsorHandler() {
	if (active('sponsor2')) {
		D('postSponsor').style.display = "none";
		D('postSponsorInput').value = "";
	} else {
		D('postSponsor').style.display = "";
		// D('sponsorInput').focus();
		flash(D('postSponsorInput'));
		D('postSponsorInput').scrollIntoView({behavior: "smooth", block:"nearest"});
	}
	toggle(D('sponsor2'));
}

function subscribeHandler(subscribee) {
	subscribee = subscribee || D('browseHeading').title;
	
	if (D("tag-" + subscribee)) flash(D("tag-" + subscribee));
	else if (D(subscribee)) flash(D(subscribee));
	else {
		makeSubLi(subscribee);
		if (ws) ws.emit("subscribe", {userid: subscribee});
	}	
	if (D(subscribee)) D(subscribee).scrollIntoView({behavior: "smooth", block:"nearest"});
	else D("tag-" + subscribee).scrollIntoView({behavior: "smooth", block:"nearest"});
}

function addTag() {
	let newTagFlag = D('set-tag').value.toLowerCase().trim();
	D('set-tag').value = "";
	if (!newTagFlag) return true;
	for (let i = 0; i < D('editTags').children.length; i++) {
		if (D('editTags').children[i].textContent == newTagFlag) {
			flash(D('editTags').children[i]);
			return true;
		}
	}
	let newTag = make('span', newTagFlag);
	newTag.onclick = function() { remove(newTag); }
	newTag.style = "cursor:pointer; margin:5px 10px 0px 10px; padding:3px 5px 3px 5px; border-radius:5px; display:inline-block";
	D('editTags').appendChild(newTag);
	flash(newTag);
}

function checkTitle(elt) {
	let prev = "";
	try { prev = new URLSearchParams((new URL(elt.value)).search).get('postid');} 
	catch { prev = "" };
	let buttonElt = elt.parentNode.lastElementChild;
	buttonElt.classList.remove('active');
	buttonElt.disabled = true;
	
	let titleElt = elt.parentNode.previousElementSibling.firstElementChild;
	if (prev) {
		if (postCache[prev]) titleElt.textContent = postCache[prev].title;
		else titleElt.textContent = "(unknown post)";
		
		if (prev.split("-")[0] == XNO.address) {
			buttonElt.classList.add('active');
			buttonElt.disabled = false;
		}
	} else if (elt.value.length) titleElt.textContent = "(Invalid URL)";
	else titleElt.textContent = "(none)";
}

function showEditor() {
	clearDOM(D('postPreview'));
	D('postPreview').style.display = "none";
	D('postEditor').style.display = "";
	
	D('editButton').classList.add('active');
	D('previewButton').classList.remove('active');
}

function showPreview(elt) {
	fillContent(D('postPreview'), parseEditorContent(D('postEditor')), parseEditorWall(), XNO.address);	
	D('postEditor').style.display = "none";
	D('postPreview').style.display = "";
	
	D('previewButton').classList.add('active');
	D('editButton').classList.remove('active');
}

function publish() {
	if (!D('postTitle').value.trim()) {
		alert("Title required.");
		return false;
	}
	let prev = "";
	try { prev = new URLSearchParams((new URL(D('set-prev').value)).search).get('postid');} 
	catch { prev = "" };
	let next = "";	
	try { next = new URLSearchParams((new URL(D('set-next').value)).search).get('postid');} 
	catch { next = "" };
	
	let tags = [];
	for (let i = 0; i < D('editTags').children.length; i++) {	
		tags.push(D('editTags').children[i].textContent);
	}
	let postData = {wall:parseEditorWall(), content:parseEditorContent(D('postEditor')), title:D('postTitle').value.trim(), tags,
							prev_: prev, next_: next, recip_prev: active('recip-prev'), recip_next: active('recip-next'), createdts: parseInt(editPostid.split("-")[1]) };
	console.log(postData);
	ws.emit('updatePost', postData);
}

function setData() {
	if (ws && ws.readyState == 1) {		
		queueDOMdisplayName(XNO.address, D('displayName'), true);
		queueDOMdisplayName(XNO.address, D('browseHeading'), true);
		queueDOMdisplayName(XNO.address, D(XNO.address).lastElementChild);
		
		ws.emit('updateUser', {displayname:D('bio-name').value, color:parseInt(D('colorslider').value), bio:parseEditorContent(D('bioBlocks')), sponsor_price: D('inputPrice').value });
		closeBioEditor();
	}
}

function parseEditorWall() {
	let wall = [];
	let k = 0;
	for (let i = 0; i < D('postEditor').children.length; i++) {
		if (D('postEditor').children[i].firstChild.value) {
			if (active(D('postEditor').children[i].children[1].firstChild)) wall.push(k);
			k++;
		}
	}
	return wall;
}

function parseEditorContent(elt) {
	let content = [];
	for (let i = 0; i < elt.children.length; i++) {
		if (elt.children[i].firstChild.value) content.push({content:elt.children[i].firstChild.value, type:elt.children[i].firstChild.title});
	}	
	return content;
}

function openBioEditor() {
	D('bioPreview').style.display = "none";
	D('bioEditor').style.display = "";
	
	if (displayNameCache[XNO.address]) D('bio-name').value = funName(XNO.address);
	D('bio-name').placeholder = funName(XNO.address, true) + "...";
	if (colorCache[XNO.address]) inputEvent(D('colorslider'), funColor(XNO.address, false, true));
	else inputEvent(D('colorslider'), 0);
	
	let data = userCache[XNO.address];
	if (!data) data = {};	
	fillEditorContent(data.bio, D('bioBlocks'));	
	if (data.sponsor_price) D('inputPrice').value = data.sponsor_price;
	//else D('inputPrice').value = "1.00";
	
	// D('bio-name').focus();
}

function closeBioEditor() {
	D('bioEditor').style.display = "none";
	if (D('browseHeading').title != "Recent") D('bioPreview').style.display = "";
	clearDOM(D('bioBlocks'));
	
	D('bio-name').value = "";
	D('bio-name').placeholder = "Public display name...";
	
	if (XNO.address) {
		D('leftSidebar').style.backgroundColor = "hsl(" + funColor(XNO.address, false, true) + ", 55%, 80%)";
		setCSS('--hue', funColor(XNO.address, false, true));
	}
}

function cancelPost(override) {
	if (!override && hasDraft() && !confirm("Clear draft?")) return false;
	showEditor();
	editPostid = "";
	editPostContent = "";
	D('editid').style.display = "none";
	D('creationEdit').textContent = "";
	D('creationEdit').title = "";
	D('modificationEdit').textContent = "";
	D('modificationEdit').title = "";	
	
	clearDOM(D('postEditor'));	
	appendBlockEditor();	
	
	D('postTitle').value = "";	
	inputEvent(D('set-prev'), "");
	inputEvent(D('set-next'), "");
	
	clearDOM(D('editTags'));
	D('set-tag').value = "";
	
	let readPanelize = (D('clearButton').textContent == "Cancel");
	
	D('publishButton').textContent = "Publish";
	D('clearButton').textContent = "Clear";
	
	if (active('toggleEdit')) D('toggleEdit').click();
	setTabTitle("Write");
	
	// if (readPanelize) loadPanel('read');
	return true;
}

function hasDraft() {
	for (let i = 0; i < D('postEditor').children.length; i++) {
		if (D('postEditor').children[i].firstChild.value) return true;
	}
	return false;
}

function commentKeypress() {
	if (event.keyCode == 27 && (!D('commentContent').value.length || confirm("Delete comment?"))) {
		D('commentContent').value = "";
		D('commentContent').style.display = "none";
		D("comment").textContent = "Comment";
		event.stopPropagation();
	} else if (D('commentContent').value) D("comment").textContent = "Comment";
	else D("comment").textContent = "Cancel";
}

function comment() {
	if (D('commentContent').style.display) {
		D('commentContent').style.display = "";
		D("comment").textContent = "Cancel";
		D('commentContent').focus();
	} else {
		D('commentContent').style.display = "none";
		D("comment").textContent = "Comment";
		ws.emit('updateComment', {content:D('commentContent').value, postid: readPostid});
		D('commentContent').value = "";
	}
}

// Sidebar UI interaction handlers ///////////////////////////////////////////////////////////////////////

var clipboardText;

function generateSeed() {
	let newSeed = XNO.generateSeed();
	inputEvent(D("seed"), newSeed);
	if (XNO.seed == newSeed) {
		navigator.clipboard.writeText(newSeed);
		clipboardText = newSeed;
		showMsg("New PIN copied to clipboard. Save it securely!");
	}
}

function importSeed() {
	let seed = D("seed").value;
	let index = 0;
	if (!XNO.checkSeed(seed)) { if (XNO.checkAddress(seed)) showMsg("Enter a PIN, not an address."); }
	else if (index.length > 0 && (!/^[0-9]+$/.test(index) || index < 0 || index > Math.pow(2, 32) - 1)) showMsg("Invalid account index.");
	else if (seed == XNO.seed) return false;
	else {
		if (!XNO.address || confirm('Log out of the current account? (Have you have saved your account PIN elsewhere?!)')) {
			clearSeed();		
			XNO.unpackSeed(seed, parseInt(index));						
			queueDOMdisplayName(XNO.address, D('displayName'), true);
			D('leftSidebar').style.backgroundColor = "hsl(" + funColor(XNO.address, false, true) + ", 55%, 80%)";
			setCSS("--butsat", "50%");
			setCSS("--hue", funColor(XNO.address, false, true));
			
			D("libraryPlaceholder").textContent = "- no history -";
			D("subPanel").style.display = "flex";
			D("notePanel").style.display = "flex";
			localStorage.setItem("localSeed", XNO.seed);
			
			buttonLogout(false);			
			makeSubLi(XNO.address);
			if (ws && ws.readyState == 1) {
				let ts = Date.now();
				ws.emit('authenticateUser', {userid: XNO.address, ts, signature:XNO.sign(ts, XNO.address)});			
			}
			if (D('browseHeading').title && browseCache[D('browseHeading').title]) fillBrowseList(browseCache[D('browseHeading').title]);
			refreshBalance("XNO");
		}
		D("seed").value = "";
	}
}

function buttonLogout(side) {
	D("currentLoginButton").disabled = side;	
	D("logoutButton").disabled = side;
	D("publishButton").disabled = side;
	
	D("subscribe").disabled = side;
	if (readPostid) for (let i = 0; i < readPanelButtons.length; i++) { readPanelButtons[i].disabled = side; }
	
	D('sendButton').disabled = side;
	D('postSendButton').disabled = side;
	
	D('edit').style.display = "none";
	D('edit2').style.display = "none";
	D('profileBut').style.display = "none";
	
	if (!side) {
		if (D('browseHeading').title == XNO.address || D('browseHeading').title.substring(0, 5) != "nano_") D('sendButton').disabled = true;
		if (readPostid.split("-")[0] == XNO.address) {
			D('postSendButton').disabled = true;
			D('edit').style.display = "";
			D('edit2').style.display = "";
		}
		if (D('browseHeading').title == XNO.address) D('profileBut').style.display = "";
	}
}

function clickClearSeed() {
	clearSeed();	
	XNO.privateKey = "";
	XNO.publicKey = "";
	XNO.address = "";
	XNO.seed = "";
	XNO.encryptKey = "";	
	D('displayName').textContent = "Guest";	
	D('leftSidebar').style.backgroundColor = "hsl(0, 0%, 80%)";
	setCSS("--butsat", "0%");
	
	D("libraryPlaceholder").textContent = "- no history (sign in to persist) -";
	D("subPanel").style.display = "none";	
	D("notePanel").style.display = "none";	
	localStorage.removeItem("localSeed");
	
	buttonLogout(true);
	inputEvent(D("seed"), "");
	
	if (D('browseHeading').title && browseCache[D('browseHeading').title]) fillBrowseList(browseCache[D('browseHeading').title]);
}

function clearSeed() {
	// clearing actions that are needed even if switching accounts	
	clearDOM(D('subscriptions'));
	clearDOM(D('library'));
	clearDOM(D('notifications'));
	D('notificationHeading').textContent = "Activity";
	noteCount = 0;
	setTabTitle(false, true);
	D('libraryPlaceholder').style.display = "";	
	D('notificationPlaceholder').style.display = "";	
	if (D('creationEdit').title) cancelPost(true);
	closeAccordion(D('editPanel'));
	D('balance').textContent = "0.00";
	
	closeBioEditor();
}

function makeNoteLi(data) {	
	let userid = data.senderid.split("-")[0];	
	let theLabel = make('div');
	theLabel.style = "font-size:0.85em; overflow:hidden; text-overflow:ellipsis;";
	theLabel.appendChild(authorLabel(userid));
	
	let dateDiv = timeLabel(data.timestamp);
	dateDiv.style.color = "#888";
	dateDiv.style.marginLeft = "5px";
	theLabel.appendChild(dateDiv);
	
	let text = make('div');
	text.style.marginLeft = "1em";
	if (data.ntype == "comment") {
		if (data.message.previd) {
			if (data.message.previd.split("-")[0] == XNO.address) text.textContent = "Replied to you in a discussion on ";
			else if (data.message.parentid && data.message.parentid.split("-")[0] == XNO.address) text.textContent = "Replied to your discussion on ";
			else text.textContent = "Replied to a discussion on ";
		} else if (data.message.parentid) {
			if (data.message.parentid.split("-")[0] == XNO.address) text.textContent = "Replied to your comment on ";
			else text.textContent = "Replied to a comment on ";
		} else text.textContent = "Commented on ";
		let postid = data.message.postid;
		let link = make('a');
		link.style.fontStyle = "italic";
		link.textContent = "your post";		
		if (postCache[postid]) link.textContent = postCache[postid].title;
		url.search = new URLSearchParams({postid});
		link.href = url;
		
		link.onclick = function() {
			event.preventDefault();
			fillPost(postid);
		}
		
		text.appendChild(link);
	}
	if (data.ntype == "subscribe") text.textContent = "Subscribed!";
	if (data.ntype == "sponsor") text.textContent = "Sponsored!";
	theLabel.appendChild(text);
	
	if (D('notifications').firstElementChild) {
		theLabel.style.marginBottom = "0.85em";
		D('notifications').insertBefore(theLabel, D('notifications').firstElementChild);
	} else {
		D('notificationPlaceholder').style.display = "none";
		D('notifications').appendChild(theLabel);
	}
	
	if (data.notifCounter) noteCount = data.notifCounter;
	if (noteCount) D('notificationHeading').textContent = "Activity (" + noteCount + ")";
	setTabTitle(false, true);
}

function makeSubLi(userid, data) {
	let label = {userid}
	if (userid.substring(0, 5) != "nano_") label = {tag:userid};
	
	let subli = make('a');
	subli.style = "display:block; width:100%; padding:4px; position:relative; color: #333";	
	url.search = new URLSearchParams(label);
	subli.href = url;
	subli.onclick = function() {
		event.preventDefault();
		queryBrowse(label);
		flash(this.parentNode);
	};
	
	let actions = make('div');
	actions.style = "position:absolute; top:0px; right:0px; display:none; opacity:0.8";
	subli.appendChild(actions);	
	subli.onmouseenter = function() { actions.style.display = ""; }
	subli.onmouseleave = function() { actions.style.display = "none"; }
	
	if (userid != XNO.address && (!data || !data.expiryts || data.expiryts < Date.now())) {
		let unsubBut = make("button", "✕");
		unsubBut.style.marginRight = "5px";
		unsubBut.onclick = function() {
			event.stopPropagation();
			event.preventDefault();
			remove(subli.parentNode);
			if (ws) ws.emit('unsubscribe', {userid});
		};	
		actions.appendChild(unsubBut);
	}
	
	let nameSpan = make('span', userid);
	if (label.userid) queueDOMdisplayName(userid, nameSpan);
	nameSpan.style.fontWeight = "600";
	subli.appendChild(nameSpan);

	if (data) {
		if (data.lastpublishedts) {
			let publishSpan = make('span', "\xa0\xa0" + timeSince(data.lastpublishedts));
			publishSpan.id = userid + "-time";
			publishSpan.title = unixToTime(data.lastpublishedts);
			if (label.tag) publishSpan.id = "tag-" + userid + "-time";
			publishSpan.style = "font-size:0.85em; color:#888";
			if (data.lastaccessedts && data.lastaccessedts < data.lastpublishedts) publishSpan.style.fontWeight = "bold";
			subli.appendChild(publishSpan);			
		}
		
		if (data.expiryts) {
			let expirySpan;
			if (data.expiryts > Date.now()) {
				newDate = 2*Date.now() - data.expiryts;
				expirySpan = make('span', "Premium sponsorship • " + timeSince(newDate) + " left");
			} else {			
				expirySpan = make('a', "Premium sponsorship • ended " + timeSince(data.expiryts) + " ago");
				//expirySpan.style = "font-style:italic";
				expirySpan.onclick = function() {			
					event.preventDefault();
					event.stopPropagation();
					queryBrowse(label);
					sponsorHandler();
					flash(subli.parentNode);
				}
			}
			expirySpan.title = unixToTime(data.expiryts);
			
			let expiryHolder = make('div');
			expiryHolder.style = "font-size:0.85em; margin-left:1em";
			expiryHolder.appendChild(expirySpan);
			subli.appendChild(expiryHolder);			
		}
	}
	
	let subliwrap = make("li");
	subliwrap.id = userid;
	if (label.tag) subliwrap.id = "tag-" + userid;
	subliwrap.appendChild(subli);
	if (D(userid)) D(userid).replaceWith(subliwrap);
	else D('subscriptions').appendChild(subliwrap);
	
	if (D('browseHeading').title) {
		if (D(D('browseHeading').title)) activeBar(D(D('browseHeading').title));
		if (D("tag-" + D('browseHeading').title)) activeBar(D("tag-" + D('browseHeading').title));
	}
}

function updateLibLi(postid, lastaccessedts) {
	let finalState = "bold";
	if (lastaccessedts) finalState = "";
	
	let libli = D(postid);
	if (!libli) {
		libli = make('li');
		libli.id = postid;
		libli.style.whiteSpace = "nowrap";
		//if (pushedts) libli.appendChild(make('span', timeSince(pushedts)));
		if (D('library').firstElementChild) D('library').insertBefore(libli, D('library').firstElementChild);
		else {
			D('library').appendChild(libli);
			D('libraryPlaceholder').style.display = "none";
		}
	} else {
		if (!lastaccessedts) finalState = libli.firstElementChild.firstElementChild.style.fontWeight;
		clearDOM(D(postid));
	}
	libli.appendChild(fullLabel(postid, "library"));
	
	libli.firstElementChild.firstElementChild.style.fontWeight = finalState;
	if (postid == readPostid) activeBar(libli);
}

function showCurrent() {
	if (XNO.seed) {
		D(`seed`).value = XNO.seed;
		flash(D(`seed`));
	} else console.log("No seed loaded.");
}

function toggleVisibility() {
	if (D("seed").type === "password") {
		D("seed").type = "text";
		D("show").classList.add('active');
	} else {
		D("seed").type = "password";		
		D("show").classList.remove('active');
	}
}

// Global event listeners ///////////////////////////////////////////////////////////////////////

window.addEventListener('blur', function() { iFrameCycle(); });
window.addEventListener('focus', function() { iFrameCycle(true); });	

function iFrameCycle(focus) {
	let iframesNew = [];
	for (let i = 0; i < iframes.length; i++) {
		if (iframes[i].parentNode) {
			iframesNew.push(iframes[i]);
			if (iframes[i].style.borderColor != "transparent") {
				if (focus) deselect(iframes[i]);
				else select(iframes[i]);
			}
		} 
	}
	iframes = iframesNew;
}

function deselect(elt) {
	elt.style.borderColor = "transparent";
	//elt.style.filter = "saturate(0.5) opacity(0.6)";
}	

function partialDeselect(elt) {
	elt.style.borderColor = "hsl(var(--hue), 0%, 90%)"; 
	//elt.style.filter = "opacity(0.6)";
}

function select(elt) {
	elt.style.borderColor = "hsl(var(--hue), var(--butsat), 80%)";
	//elt.style.filter = "";
}

			
window.addEventListener("beforeunload", function (e) {
    var confirmationMessage = 'It looks like you have been drafting something. If you leave before posting, your changes will be lost.';
	if (hasDraft() || D('commentContent').value.length > 0) {
		(e || window.event).returnValue = confirmationMessage; //Gecko + IE
		return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
	}
});

window.addEventListener('popstate', function() { 
	if (!closeSidebar()) {
		if (backList.length) {
			window.history.pushState(null, "", new URL(window.location));
			loadPanel(backList.pop(), true, true);
		} else loadURL(); 
	}
	//else window.history.pushState(null, "", new URL(window.location));
});

function closeSidebar() {
	if (D('browse').style.display != 'none' && active('toggleBrowse')) D('toggleBrowse').click();
	else if (D('read').style.display != 'none' && active('toggleRead')) D('toggleRead').click();
	else if (D('write').style.display != 'none' && active('toggleEdit')) D('toggleEdit').click();
	else return false;	
	event.preventDefault();
	return true;
}

function loadURL(link) {
	let activeClick = false;
	if (link) activeClick = true;
	else link = window.location;
	let params = new URLSearchParams(link.search);
	if (params.get('postid') != null) {
		if (ws && ws.readyState == 1 && !D('browseHeading').textContent) queryBrowse({}, true, true);
		if (params.get('postid')) fillPost(params.get('postid'), !activeClick);
		else loadPanel("read");
	} else if (params.get('editid') != null) {
		if (ws && ws.readyState == 1 && !D('browseHeading').textContent) queryBrowse({}, true, true);
		if (XNO.address == params.get('editid').split("-")[0] && (editPostPending || editPostid != params.get('editid'))) fillEdit(params.get('editid'));
		else loadPanel("write");
	} else if (params.get('userid')) {
		if (params.get('userid') != browseURL.userid || !browseCache[browseURL.userid]) queryBrowse({userid:params.get('userid')}, !activeClick);
		else loadPanel("browse");
	} else if (params.get('tag')) {
		if (params.get('tag') != browseURL.tag || !browseCache[browseURL.tag]) queryBrowse({tag:params.get('tag')}, !activeClick);
		else loadPanel("browse");
	} else {
		if (browseURL.tag || browseURL.userid || !browseCache["Recent"]) queryBrowse({}, !activeClick);
		else loadPanel("browse");
	}
	
	if (ws && ws.readyState == 3) {	setupWebsocket(); }
}

window.addEventListener('message', function() {
	if (event.data.height > 0) {
		let h = event.data.height;
		if (h > 4096) h = 4096;		
		let sender = Array.from(document.getElementsByTagName('iframe')).filter(iframe => {
			return iframe.contentWindow === event.source;
		});
		if (sender.length) {
			sender[0].style.height = h + "px";
			console.log(sender[0].clientWidth);
			event.source.postMessage({width:sender[0].clientWidth}, "*");
		}
	}
});

window.addEventListener('copy', function(e) { 
	if (document.activeElement.tagName.toLowerCase() == 'input') 
		clipboardText = document.activeElement.value.substring(document.activeElement.selectionStart, document.activeElement.selectionEnd);
	else if (document.getSelection().toString()) {
		clipboardText = document.getSelection().toString();	
		navigator.clipboard.writeText(clipboardText);
	}
});

window.addEventListener('keydown', function(evt) {
	if (document.activeElement.tagName.toLowerCase() != 'input' && document.activeElement.tagName.toLowerCase() != 'textarea') {
	//	if (evt.keyCode == 8 && backList.length && !closeSidebar()) {
	//		evt.preventDefault();
	//		loadPanel(backList.pop(), false, true);
	//	} 
		
		if (evt.keyCode == 27) {
			evt.preventDefault();
			loadPanel('browse', false, true);
			backList = [];
		}
	}
	if (evt.altKey) {
		if (evt.keyCode == 49) loadPanel('browse', true);
		else if (evt.keyCode == 50) loadPanel('read', true);
		else if (evt.keyCode == 51) loadPanel('write', true);		
		else if (evt.keyCode == 81) {
			if (active('readButton') && readPostid && postCache[readPostid].userid == XNO.address) fillEdit();
			else if (active('writeButton') && D('postEditor').style.display == "none") showEditor();
			if (active('writeButton') && document.activeElement.tagName.toLowerCase() != 'input' && document.activeElement.tagName.toLowerCase() != 'textarea') {
				D('postEditor').firstElementChild.firstElementChild.focus();
			}
		} else if (evt.keyCode == 87) {
			if (active('writeButton') && D('postPreview').style.display == "none") {
				event.preventDefault();
				showPreview();
			}
		}
	}
});

var currentElt;

function scrollPanel(elt) {
	if (screen.width <= 600 || screen.height <= 600) {
		currentElt = elt;
		setTimeout(function() {if (currentElt == elt) currentElt = null;}, 2000);
	}
}

window.addEventListener("resize", function() { if (currentElt) currentElt.scrollIntoView({block:'start', behavior:'auto'});	});


// UI helper library ///////////////////////////////////////////////////////////////////////

function funName(userid, generated) {
	if (displayNameCache[userid] && !generated) return displayNameCache[userid];
	return adj[parseInt(XNO.pubFromAddr(userid).substring(0, 10), 16) % adj.length] + " " + animals[parseInt(XNO.pubFromAddr(userid).substring(0, 10), 16) % animals.length];
}

function funColor(userid, generated, raw) {
	let genColor = parseInt(XNO.pubFromAddr(userid).substring(0, 10), 16) % 360;
	if (colorCache[userid] && !generated) genColor = colorCache[userid];
	if (raw) return genColor;
	return "hsl(" + genColor + ", 100%, 27%)";
}

function D(string) { 
	if (!string) console.error("Empty dom string");
	return document.getElementById(string); 
}

function refreshNoteCounter() {
	ws.emit('updateNotifCounter');
	noteCount = 0;
	setTabTitle(false, true);
	D('notificationHeading').textContent = "Activity";
}

function toggleSubAccordion(but) {
	let obj = but.parentNode.lastElementChild;
	if (obj.style.maxHeight == "0px") openSubAccordion(but.parentNode);
	else closeAccordion(obj); 
}

function openSubAccordion(but) {
	let obj = but.lastElementChild;	
	if (obj.style.maxHeight == "0px") {
		showAccordion(obj);	
		setTimeout(function() { if (obj.style.maxHeight != "0px") obj.style.maxHeight = ""; }, 100);
	}
}

function closeAccordion(obj) {
	if (obj.style.maxHeight != "0px") showAccordion(obj);
	setTimeout(function() { 
		obj.style.maxHeight = "0px";
		obj.style.marginTop = "0px";
		obj.style.marginBottom = "0px";
	}, 1);
}

function showAccordion(obj) { obj.style.maxHeight = obj.scrollHeight + "px"; }

function flash(elt, str) {
	if (elt) {
		if (str != undefined) elt.textContent = str;
		elt.style.backgroundColor = 'hsl(var(--hue), var(--butsat), 93%)';	
		setTimeout(function() {	elt.style.backgroundColor = "";}, 500);
	} else console.log("Element disappeared before display.");
}

function inputEvent(obj, value) {
	obj.value = value;
	obj.dispatchEvent(new Event('input', {bubbles:true}));
	if (value) flash(obj);
}

function closeCopy(obj) {
	if (obj.value.length > 0) inputEvent(obj, "");
	else if (navigator.clipboard.readText) {
		navigator.clipboard.readText()
			.then(function(text) { inputEvent(obj, text); })
			.catch(function() { if (clipboardText) inputEvent(obj, clipboardText); });
	}
	else if (clipboardText) inputEvent(obj, clipboardText);
}

function clickCopy(elt, str) {
	if (str.length > 1) {
		/* Copy the text inside the text field */
		navigator.clipboard.writeText(str);
		clipboardText = str;
		showMsg("Copied to clipboard.");
	}
	flash(elt);
}

function clickPaste(elt, read) {
	if (read) inputEvent(D('postSponsorInput'), elt.textContent);
	else inputEvent(D('sponsorInput'), elt.textContent);
}

var msgTimer;
function showMsg(str, bold, hold) {
	let e = new Date();
	D('msg').style.display = "";
	D('msg').style.transition = "";
	if (msgTimer) clearTimeout(msgTimer);
	D('msg').style.filter = "opacity(0.9)";
	// flash(D('msg'), e.toLocaleTimeString() + ": " + str);
	flash(D('msg'), str);
	if (bold) D('msg').style.backgroundColor = "#F00";
	if (!hold) msgTimer = setTimeout(function() {
		D('msg').style.transition = "filter 2s linear 0s";
		D('msg').style.filter = "opacity(0)";
	}, 5000);
}

function unixToDate(time) {
	let format = new Date(time).toLocaleDateString(undefined,{year: 'numeric', month: 'short', day: 'numeric' });
	//if (str.getYear() == (new Date(Date.now())).getYear()) return format.slice(0, -6); 
	//else 
	return format;
}

function unixToTime(time) {
	let format = new Date(time).toLocaleString(undefined,{year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' });
	//if (str.getYear() == (new Date(Date.now())).getYear()) return format.slice(0, -6); 
	//else 
	return format;
}

function remove(elt) { elt.parentNode.removeChild(elt); }
function clearDOM(myNode) {	while (myNode.firstChild) { myNode.removeChild(myNode.lastChild); } }

function make(string, text) { 
	let myObj = document.createElement(string);
	if (text) myObj.textContent = text;
	return myObj;
}

function toggle(div) {
	if (div.classList.contains('active')) div.classList.remove('active');
	else div.classList.add('active');
}

function timeSince(date) {
	if (typeof date !== 'object') date = new Date(date);

	var seconds = Math.floor((new Date() - date) / 1000);
	var intervalType;

	var interval = Math.floor(seconds / 31536000);
	if (interval >= 1) intervalType = 'y';
	else {
		interval = Math.floor(seconds / 2592000);
		if (interval >= 1) intervalType = 'mo';
		else {
			interval = Math.floor(seconds / 86400);
			if (interval >= 1) intervalType = 'd';
			else {
				interval = Math.floor(seconds / 3600);
				if (interval >= 1) intervalType = "h";
				else {
					interval = Math.floor(seconds / 60);
					if (interval >= 1) intervalType = "m";
					else {
						interval = seconds;
						intervalType = "s";
					}
				}
			}
		}
	}

	//  if (interval > 1 || interval === 0) intervalType += 's';
	return interval + intervalType;
}

function addTabbing(elt) {
    elt.onkeydown = function(evt) {
        let text = elt.value;
        let sel = elt.selectionStart;
		let selEnd = elt.selectionEnd;
        switch (evt.key) {
            case "Escape":
                evt.preventDefault();
				evt.stopPropagation();
				if (elt.parentNode.nextElementSibling) elt.parentNode.nextElementSibling.focus();
				else elt.parentNode.focus();
				break;
            case "Enter":
                if (sel == selEnd) {
                    // find start of the current line
                    while (sel > 0 && text[sel-1] != '\n') sel--;

                    let lineStart = sel;
                    while (text[sel] == ' ' || text[sel]=='\t') sel++;

                    if (sel > lineStart) {
                        evt.preventDefault();
                        // Insert carriage return and indented text
                        document.execCommand('insertText', false, "\n" + text.substr(lineStart, sel-lineStart));

                        // Scroll caret visible
                        elt.blur();
                        elt.focus();
                    }
                }
				break;
            case "Tab":
                evt.preventDefault();
                // selection?
                if (sel == selEnd) { // These operations are undoable
                    if (!evt.shiftKey) document.execCommand('insertText', false, "\t");
                    else if (elt.selectionStart > 0 && text[elt.selectionStart-1]=='\t') document.execCommand('delete');
                } else { // Block indent/unindent trashes undo stack.
                    // Select whole lines
                    while (sel > 0 && text[sel-1] != '\n') sel--;
                    while (selEnd > 0 && text[selEnd-1]!='\n' && selEnd < text.length) selEnd++;

                    // Get selected text
                    let lines = text.substr(sel, selEnd - sel).split('\n');

                    // Insert tabs
                    for (var i=0; i<lines.length; i++) {
                        // Don't indent last line if cursor at start of line
                        if (i==lines.length-1 && lines[i].length==0) continue;

                        // Tab or Shift+Tab?
                        if (evt.shiftKey) {
                            if (lines[i].startsWith('\t')) lines[i] = lines[i].substr(1);
                            else if (lines[i].startsWith("    ")) lines[i] = lines[i].substr(4);
                        } else lines[i] = "\t" + lines[i];
                    }
                    let output = lines.join('\n');

                    // Update the text area
                    elt.value = text.substr(0, sel) + output + text.substr(selEnd);
                    elt.selectionStart = sel;
                    elt.selectionEnd = sel + output.length; 
                }
        }
    } 
}

function active(elt) {
	if (typeof elt === 'string' || elt instanceof String) elt = D(elt);
	return elt.classList.contains('active');
}

function activeBar(elt) {
	elt.firstElementChild.style.borderLeft = "solid 4px hsl(var(--hue), var(--butsat), 80%)";
	elt.firstElementChild.style.borderRadius = "5px";
	elt.firstElementChild.style.paddingLeft = "10px";
}

function removeActiveBar(elt) {
	elt.firstElementChild.style.borderLeft = "";	
	elt.firstElementChild.style.borderRadius = "";
	elt.firstElementChild.style.paddingLeft = "5px";
}

function toggleSecondDiv(elt) {
	if (active(elt)) {
		elt.nextElementSibling.classList.remove("desktop");
		elt.nextElementSibling.nextElementSibling.classList.add("desktop");
	} else {	
		elt.nextElementSibling.classList.add("desktop");
		elt.nextElementSibling.nextElementSibling.classList.remove("desktop");
		window.history.pushState(null, "", new URL(window.location));
	}
	toggle(elt);
}

function color(elt) {
	let theColor = elt.value;
	if (theColor == "0") theColor = funColor(XNO.address, true, true);
	elt.previousElementSibling.style.color = 'hsl(' + theColor + ', 100%, 27%)';
	setCSS('--hue', theColor);
	
	D('leftSidebar').style.backgroundColor = "hsl(" + theColor + ", 55%, 80%)";
}

function setCSS(variable, value) { document.documentElement.style.setProperty(variable, value);}

function fileSize(url) {
    return new Promise((resolve, reject) => {
        let xhttp = new XMLHttpRequest();
        xhttp.timeout = 10*1000; // 10 seconds
        xhttp.onreadystatechange = function() {
			if (this.readyState == 4) {
				console.log("File size: " + xhttp.getResponseHeader("Content-Length"));
				resolve(xhttp.getResponseHeader("Content-Length"));
			}
        };
		xhttp.open("HEAD", url, true); // Notice "HEAD" instead of "GET",  to get only the header
        xhttp.send();
    });
}

function setLocalJSON(name, data) { localStorage.setItem(name, JSON.stringify(data)); }

function getLocalJSON(name) {
	let data = localStorage.getItem(name);
	if (data) data = JSON.parse(data);
	return data;
}

function post(url, params) {
    return new Promise((resolve, reject) => {
        let xhttp = new XMLHttpRequest();
        xhttp.timeout = 15*1000; // 15 seconds
        xhttp.onreadystatechange = function() {
			if (this.readyState == 4) {
				if (this.status == 200) {
					try { resolve(JSON.parse(this.responseText)); } 
					catch(e) {
						console.error('Failed to parse response from node');
						console.error(this.responseText);
						resolve();
					}
				} else {
					console.error('Failed to connect to '+ url + ". Parameters:", params);
					resolve();
				}
			}
        };
        xhttp.open("POST", url, true);
        xhttp.setRequestHeader("Content-Type", "application/json");
        xhttp.send(JSON.stringify(params));
    });
}	

</script>

</body>
</html>
